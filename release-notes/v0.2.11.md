# Release Notes: v0.2.11

**Date**: 2025-11-12

Type safety and testing excellence release completing cross-language type bindings for fulpack archive module and establishing portable testing practices standard across the FulmenHQ ecosystem.

## Highlights

- **Fulpack Type Generation Complete**: Cross-language type bindings (Python, TypeScript, Go) with compile-time verification
- **Portable Testing Practices Standard**: Ecosystem-wide guidance for deterministic test execution across development and CI environments
- **Cross-Language Parity**: Full type coverage across all three supported languages with automated verification
- **Developer Experience**: Clean imports, type safety, and consistent testing patterns across the ecosystem

## What's New

### 1. Fulpack Type Generation Complete

Complete cross-language type generation system for fulpack archive module with automated verification and compilation checks.

#### TypeScript Types

**Location**: `lang/typescript/src/fulpack/`

**Key Files**:

- **types.ts** (172 lines):
  - String literal union types: `ArchiveFormat`, `EntryType`, `Operation`
  - Readonly interfaces: `ArchiveInfo`, `ArchiveEntry`, `ArchiveManifest`, `ValidationResult`, `ExtractResult`
  - Options interfaces: `CreateOptions`, `ExtractOptions`, `ScanOptions` (all fields optional)
  - Module constant: `FULPACK_VERSION = "v1.0.0"`
- **index.ts**: Clean re-exports for simplified imports

**Usage**:

```typescript
import {
  ArchiveFormat,
  ArchiveInfo,
  CreateOptions,
} from "@fulmenhq/crucible/fulpack";

const format: ArchiveFormat = "tar.gz";
const options: CreateOptions = {
  compression_level: 9,
  checksum_algorithm: "sha256",
};
```

**Type Inference**: Automatic TypeScript type mapping from JSON schemas with proper readonly modifiers.

**Verification**: Compiles cleanly with `tsc --noEmit`.

#### Go Types

**Location**: `fulpack/types.go` (204 lines at repository root)

**Key Components**:

**Typed Enums with Validators**:

```go
type ArchiveFormat string

const (
    ArchiveFormatTarGz ArchiveFormat = "tar.gz"
    ArchiveFormatZip   ArchiveFormat = "zip"
    ArchiveFormatGzip  ArchiveFormat = "gzip"
)

func ValidateArchiveFormat(value ArchiveFormat) error {
    switch value {
    case ArchiveFormatTarGz, ArchiveFormatZip, ArchiveFormatGzip:
    default:
        return fmt.Errorf("invalid archiveformat: %s", value)
    }
    return nil
}
```

**Structs**: Data structures and options with JSON tags for serialization/deserialization.

**Usage**:

```go
import "github.com/fulmenhq/crucible/fulpack"

format := fulpack.ArchiveFormatTarGz
if err := fulpack.ValidateArchiveFormat(format); err != nil {
    // handle error
}

info := fulpack.ArchiveInfo{
    Format: "tar.gz",
    EntryCount: 42,
    TotalSize: 1024000,
}
```

**Verification**: Compiles cleanly with `go build ./fulpack`.

#### Python Types

**Location**: `lang/python/src/crucible/fulpack/` (completed in v0.2.10)

**Key Components**:

- **enums.py**: `ArchiveFormat`, `EntryType`, `Operation` (using `StrEnum`)
- **types.py**: `ArchiveInfo`, `ArchiveEntry`, `ArchiveManifest` (TypedDict)
- **options.py**: `CreateOptions`, `ExtractOptions`, `ScanOptions` (TypedDict, all fields optional)

**Full Cross-Language Parity**: All three languages now have matching type definitions.

#### Code Generation Infrastructure

**Templates**:

- **TypeScript**: `scripts/codegen/fulpack-types/typescript/types.template.ejs` + `postprocess.sh` (biome formatter)
- **Go**: `scripts/codegen/fulpack-types/go/types.template.ejs` + `postprocess.sh` (gofmt formatter)
- **Python**: Existing templates (v0.2.10)

**Generator Script**: `scripts/codegen/generate-fulpack-types.ts`

- Type inference functions for each language
- Template rendering with EJS
- Automatic formatting via postprocess scripts
- Support for `--lang` and `--format` flags

**Verification Script**: `scripts/codegen/verify-fulpack-types.ts`

- Regenerates types to temp directory
- Compares with checked-in versions (drift detection)
- Compilation checks:
  - TypeScript: `tsc --noEmit`
  - Go: `go build ./fulpack`
  - Python: `python -m py_compile` + import validation
- Integrated into `make verify-codegen` and `make check-all`

**Metadata Configuration**: `scripts/codegen/fulpack-types/metadata.json`

- Language-specific output directories
- Template paths
- Postprocess script configurations

#### Template Fixes

**EJS Escaping Issue**:

- **Problem**: `<%=` HTML-escapes output, causing quotes to become `&#34;`
- **Solution**: Changed to `<%-` for raw output in all type/property fields
- **Impact**: Clean generated code with proper quotes

**Go Switch Logic Issue**:

- **Problem**: `return nil` inside switch statement causing "missing return" compiler error
- **Solution**: Moved `return nil` outside switch statement in Validate functions
- **Impact**: Valid Go code with correct control flow

#### Verification Results

All generated types verified:

- **TypeScript**: ✅ Compiles with tsc, no type errors
- **Go**: ✅ Builds successfully, all validators work correctly
- **Python**: ✅ Imports cleanly, syntax valid
- **Drift Detection**: ✅ Zero drift between generated and checked-in code
- **Cross-Language Parity**: ✅ All three languages have matching type definitions

### 2. Portable Testing Practices Standard

Ecosystem-wide testing guidance ensuring deterministic test execution across laptops, CI, and sandboxed environments.

#### Core Document

**Location**: `docs/standards/testing/portable-testing-practices.md`

**Audience**: All FulmenHQ repositories (Crucible, helper libraries, forges, customer templates)

**Goal**: Keep `go test ./...`, `pytest`, `npm test` deterministic without hiding real regressions.

#### Core Principles

**1. Deterministic Execution**:

- Avoid hard-coded ports, unseeded randomness, or undeclared timeouts
- Seed PRNGs explicitly
- Derive configs from helpers
- Surface timeouts via flags/env vars

**2. Capability Detection**:

- Probe for network, filesystem, or kernel features before relying on them
- Skip with descriptive messages when missing rather than crashing
- Examples: loopback sockets, IPv6, epoll

**3. In-Memory First**:

- Prefer in-memory emitters/fakes for unit tests
- Examples: gofulmen telemetry memory emitter, SQLite `:memory:`, mock servers
- Reserve real sockets/filesystems for integration tests with capability guards

**4. Context Propagation**:

- Pass `context.Context`, correlation IDs, trace IDs through helper APIs
- Ensures logs remain actionable under test

**5. Isolated Cleanup**:

- Register cleanup handlers (`t.Cleanup`, pytest fixtures, `afterEach`)
- Tests must leave environment as found

#### Recommended Structure

**Test Modes**:

- Support `-short`, `FOO_TEST_FAST=1` flags to disable heavy integrations
- Enable tight development loops

**Shared Skip Helpers**:

- Language-specific capability detection
- Go: `RequireNetwork(t *testing.T)`
- Python: `require_network()` fixture
- Consistent skip reasons

**Resource Guards**:

- Wrap expensive operations (Prometheus exporters, DB containers)
- Accept test handle and perform capability checks

**Documentation Hooks**:

- Linked from language coding standards for easy discovery

#### Language-Specific Guidance

**Go**:

- Bind listeners via `net.Listen("127.0.0.1:0")` or `tcp4` to avoid IPv6-only binds
- Inject listeners into `httptest.Server`
- Use gofulmen's in-memory telemetry emitter for unit tests
- Guard real exporters with skip helpers
- Ensure error/logging helpers accept `context.Context` for request ID flow
- **Reference**: `docs/standards/coding/go.md#portable-testing`

**Python**:

- Use pytest fixtures: `tmp_path`, `monkeypatch` for temp dirs and environment overrides
- Call `pytest.skip` via shared helpers when sockets/DNS unavailable
- Make skips explicit: `"network capability unavailable"`
- **Reference**: `docs/standards/coding/python.md#portable-testing`

**TypeScript / Node**:

- Avoid privileged ports
- Use utilities like `get-port` to obtain ephemeral ports
- Clean up mocked timers and HTTP servers in `afterEach`
- Prevent cross-test leaks
- **Reference**: `docs/standards/coding/typescript.md#portable-testing`

#### Integration Points

**Cross-Linked From**:

- All coding standards (Go, Python, TypeScript)
- All forge standards (workhorse, codex, microtool)
- Helper library standard (testing sections)

**Synced to Language Wrappers**:

- Available in `lang/python/docs/standards/testing/portable-testing-practices.md`
- Available in `lang/typescript/docs/standards/testing/portable-testing-practices.md`

## Updated Standards

### Coding Standards

**Go** (`docs/standards/coding/go.md`):

- Added portable testing section with cross-reference
- Examples of capability detection and in-memory emitters

**Python** (`docs/standards/coding/python.md`):

- Added portable testing section with pytest fixture examples
- Skip helper patterns

**TypeScript** (`docs/standards/coding/typescript.md`):

- Added portable testing section with Jest/Vitest patterns
- Ephemeral port utilities

### Forge Standards

**Workhorse** (`docs/architecture/fulmen-forge-workhorse-standard.md`):

- Testing section now references portable testing practices
- Backend service testing patterns

**Codex** (`docs/architecture/fulmen-forge-codex-standard.md`):

- CLI testing patterns referencing portable practices
- In-memory output capture

**Microtool** (`docs/architecture/fulmen-forge-microtool-standard.md`):

- Small tool testing patterns
- Fast execution requirements

**Helper Library** (`docs/architecture/fulmen-helper-library-standard.md`):

- Module testing requirements
- Cross-language testing consistency

## Migration Guide

### For Application Developers

**TypeScript**:

```typescript
// Before
import { schemas } from "@fulmenhq/crucible";
const schema = schemas.fulpack().v1_0_0().archiveInfo();

// After (with types)
import { ArchiveInfo } from "@fulmenhq/crucible/fulpack";

const info: ArchiveInfo = {
  format: "tar.gz",
  entry_count: 42,
  total_size: 1024000,
  compressed_size: 512000,
};
```

**Go**:

```go
// Before
import "github.com/fulmenhq/crucible"

// After (with types)
import "github.com/fulmenhq/crucible/fulpack"

format := fulpack.ArchiveFormatTarGz
```

**Python**:

```python
# Before (v0.2.10, still works)
from crucible.fulpack import ArchiveFormat, ArchiveInfo

# After (v0.2.11, same imports, improved verification)
from crucible.fulpack import ArchiveFormat, ArchiveInfo

info: ArchiveInfo = {
    "format": "tar.gz",
    "entry_count": 42,
    "total_size": 1024000,
    "compressed_size": 512000,
}
```

### For Test Authors

**Apply Portable Testing Practices**:

1. **Review**: Read `docs/standards/testing/portable-testing-practices.md`
2. **Capability Checks**: Add skip helpers for tests requiring network/filesystem
3. **In-Memory First**: Replace real resources with in-memory alternatives for unit tests
4. **Cleanup**: Register cleanup handlers in all tests
5. **Context**: Ensure logging/error helpers accept context for tracing

**Language-Specific**:

- Go: Check `docs/standards/coding/go.md#portable-testing`
- Python: Check `docs/standards/coding/python.md#portable-testing`
- TypeScript: Check `docs/standards/coding/typescript.md#portable-testing`

## Technical Details

### Type Generation Workflow

```bash
# Generate types for all languages
bun run scripts/codegen/generate-fulpack-types.ts --all --format

# Generate for specific language
bun run scripts/codegen/generate-fulpack-types.ts --lang typescript --format
bun run scripts/codegen/generate-fulpack-types.ts --lang go --format
bun run scripts/codegen/generate-fulpack-types.ts --lang python --format

# Verify types are up-to-date
bun run scripts/codegen/verify-fulpack-types.ts
make verify-codegen
```

### Template Structure

Each language has:

- **types.template.ejs**: Main template with EJS logic
- **postprocess.sh**: Language-specific formatter (biome, gofmt, black)
- **Metadata entry**: Output directory and template configuration

### Cross-Language Consistency

All three languages provide:

- **Enums**: `ArchiveFormat`, `EntryType`, `Operation`
- **Data Structures**: `ArchiveInfo`, `ArchiveEntry`, `ArchiveManifest`, `ValidationResult`, `ExtractResult`
- **Options**: `CreateOptions`, `ExtractOptions`, `ScanOptions`
- **Module Version**: `FULPACK_VERSION` constant

## Breaking Changes

None. This release is additive only.

## Deprecations

None.

## Known Issues

None.

## Contributors

Generated by Schema Cartographer under supervision of @3leapsdave.

## What's Next

**v0.2.12** (Planned):

- Fulpack streaming API support
- Additional module type generation (fulencoding, etc.)
- Enhanced testing utilities based on portable practices
- Module registry expansion

**Feedback**: Report issues at https://github.com/fulmenhq/crucible/issues

---

**Full Changelog**: https://github.com/fulmenhq/crucible/blob/main/CHANGELOG.md
