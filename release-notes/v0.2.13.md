# Release Notes: v0.2.13

**Date**: 2025-11-14

Quick-turn release delivering reproducible script-generated test fixtures for comprehensive fulpack module testing across all implementations (gofulmen, pyfulmen, tsfulmen).

## Highlights

- **Fulpack Test Fixtures**: Complete script-generated fixture suite for all 4 archive formats (tar, tar.gz, zip, gzip)
- **Binary Content Testing**: First tar fixture with binary+text content for data integrity verification
- **Security Test Cases**: Pathological archives with malicious paths for security validation
- **Comprehensive Documentation**: README + per-fixture documentation explaining purpose, structure, and expected behavior

## What's New

### Fulpack Test Fixtures

Reproducible, script-generated test fixtures enabling consistent cross-language testing of the fulpack archive module.

#### Fixture Generator

**Location**: `scripts/generate-fulpack-fixtures.ts` (500+ lines)

**Features**:

- TypeScript-based generator creating all fixtures from code
- Size validation enforced programmatically (10KB compressed, 25KB tar, 50KB pathological)
- Fresh content for each fixture (no reuse to prevent coupling)
- Auto-generates `.txt` documentation for each fixture
- Integrated with `make sync-to-lang` for cross-language distribution

**Usage**:

```bash
# Generate all fixtures
bun run scripts/generate-fulpack-fixtures.ts

# Generate specific fixture
bun run scripts/generate-fulpack-fixtures.ts --fixture basic.tar

# Verify sizes without regenerating
bun run scripts/generate-fulpack-fixtures.ts --verify-only
```

#### Fixture Inventory

**Location**: `config/library/fulpack/fixtures/`

| Fixture               | Size      | Purpose                                   | Format |
| --------------------- | --------- | ----------------------------------------- | ------ |
| `basic.tar`           | 21.5 KB   | Uncompressed tar with binary+text content | tar    |
| `basic.tar.gz`        | 847 bytes | Compressed tar archive                    | tar.gz |
| `nested.zip`          | 3.4 KB    | 3-level directory nesting                 | zip    |
| `pathological.tar.gz` | 1.3 KB    | Security test cases (malicious paths)     | tar.gz |

**All fixtures now script-generated** (previous fixtures were manually created).

#### 1. basic.tar (21.5 KB)

**Purpose**: Test uncompressed tar format with binary and text data.

**Contents**:

- `README.md` - Text file (~600 bytes)
- `config.json` - Text file (~100 bytes)
- `metadata.txt` - Text file (~120 bytes)
- `data/sample.txt` - Text file (~100 bytes)
- `data/tiny.png` - Binary file (~100 bytes, PNG-like blob)

**Tests Enabled**:

- Tar format operations (create, extract, scan)
- `compression_ratio = 1.0` verification (no compression)
- Binary data integrity (PNG blob)
- Fastest operations (no compression overhead)
- Telemetry: `format=tar` label in all metrics

**Rationale**: Crucible v0.2.12 added `ArchiveFormat.TAR` as fourth standard format. This fixture enables testing tar-specific behavior distinct from tar.gz, particularly:

- Compression ratio always 1.0
- Faster operations (no compression overhead)
- Verification that `compression_level` option is ignored (no error)

**Size Note**: 25KB limit (vs 10KB for compressed) due to tar's 512-byte block padding overhead.

#### 2. basic.tar.gz (847 bytes)

**Purpose**: Test standard compressed tar archive operations.

**Contents**: Same 5-file structure as basic.tar, but compressed.

**Tests Enabled**:

- Standard tar.gz operations
- Compression ratio (~3:1 for text)
- Directory nesting (subdir/)

**Change**: Now script-generated (was manually created).

#### 3. nested.zip (3.4 KB)

**Purpose**: Test deep directory nesting and path handling.

**Contents**:

```
root.txt
level1/
  file1.txt
  level2/
    file2.txt
    level3/
      file3.txt
      deep.txt
```

**Tests Enabled**:

- 3-level directory nesting
- Zip format operations
- Path normalization

**Change**: Now script-generated (was manually created).

#### 4. pathological.tar.gz (1.3 KB)

**Purpose**: Test security protections against malicious archives.

**Contents** (simulated security test cases):

- Path traversal: `../../../etc/passwd`
- Absolute paths: `/etc/passwd`, `/root/.ssh/id_rsa`
- Symlink escapes targeting outside archive bounds

**Expected Behavior**:

- `scan()`: MUST list all entries (including malicious paths, per standard)
- `verify()`: MUST return `valid=false` with `PATH_TRAVERSAL` and `ABSOLUTE_PATH` errors
- `extract()`: MUST fail with security errors before writing files
- Telemetry: `fulpack.security.violations_total` metric incremented

**Tests Enabled**:

- Cross-format security parity verification (tar.gz vs tar vs zip)
- Security protection validation (PATH_TRAVERSAL, ABSOLUTE_PATH, SYMLINK_ESCAPE)
- Bomb detection (size/entry limits still enforced despite ratio=1.0)

**⚠️ Note**: Contains simulated malicious content for testing purposes only.

**Change**: Now script-generated (was manually created).

#### Documentation

**Fixtures Directory README**: `config/library/fulpack/fixtures/README.md`

Provides immediate context for anyone browsing the fixtures directory:

- Inventory table with all fixtures
- Purpose and usage instructions
- Why `.txt` files exist alongside binaries
- How to regenerate fixtures
- Size governance rules
- Cross-language parity information

**Per-Fixture Documentation**: Each fixture has a corresponding `.txt` file:

- `basic.tar.txt` - Documents purpose, structure, expected behavior, test coverage
- `basic.tar.gz.txt` - Same pattern
- `nested.zip.txt` - Same pattern
- `pathological.tar.gz.txt` - Same pattern

**Examples**:

- Lists all files/directories in the fixture
- Documents expected behavior for each operation (create, extract, scan, verify)
- Specifies test coverage enabled by the fixture
- Includes rationale for fixture-specific characteristics

#### Size Governance

Fixtures must stay small to avoid bloating the repository:

- **Compressed archives** (tar.gz, zip, gzip): ≤10 KB
- **Uncompressed tar**: ≤25 KB (tar has 512-byte block padding overhead)
- **Pathological/security fixtures**: ≤50 KB

The generator enforces these limits programmatically and will fail if exceeded.

#### Cross-Language Parity

Fixtures are synced to language wrappers via `make sync-to-lang`:

- **gofulmen**: Embeds from root `config/` (no sync needed)
- **pyfulmen**: `lang/python/config/library/fulpack/fixtures/`
- **tsfulmen**: `lang/typescript/config/library/fulpack/fixtures/`

All implementations must produce identical results when processing these fixtures.

## Migration Guide

### For Helper Library Implementers

**Fulpack Testing Updates**:

1. **Update test fixtures**: Pull latest from Crucible v0.2.13
2. **Add tar format tests**: Use `basic.tar` to test uncompressed tar operations
3. **Verify compression_ratio**: Ensure tar format reports `compression_ratio = 1.0`
4. **Binary data integrity**: Verify `data/tiny.png` extracts identically (byte-for-byte)
5. **Security parity**: Ensure `pathological.tar.gz` produces same errors as before

**Test Coverage Additions**:

```typescript
// Example: Test tar format compression_ratio
import { info } from "./fulpack";

test("basic.tar reports compression_ratio = 1.0", async () => {
  const archiveInfo = await info("config/library/fulpack/fixtures/basic.tar");
  expect(archiveInfo.compression_ratio).toBe(1.0);
  expect(archiveInfo.compressed_size).toBe(archiveInfo.total_size);
});

// Example: Test binary data integrity
test("basic.tar preserves binary data integrity", async () => {
  const entries = await extract("config/library/fulpack/fixtures/basic.tar");
  const pngData = entries.find((e) => e.path === "data/tiny.png");
  expect(pngData.content).toHaveLength(100);
  expect(pngData.content[0]).toBe(0x89); // PNG signature
  expect(pngData.content[1]).toBe(0x50); // 'P'
});
```

**Regenerating Fixtures Locally** (optional, for development):

```bash
# Clone Crucible
git clone https://github.com/fulmenhq/crucible.git

# Install dependencies
bun install

# Regenerate all fixtures
bun run scripts/generate-fulpack-fixtures.ts

# Verify sizes
ls -lh config/library/fulpack/fixtures/*.{tar,tar.gz,zip}

# Sync to language wrappers (if testing locally)
make sync-to-lang
```

## Technical Details

### Fixture Generation Process

1. **Content Creation**: Generator creates fresh content in `/tmp/fulpack-fixtures/`
2. **Archive Creation**: Uses native tools (tar, zip) via `execSync`
3. **Size Validation**: Programmatically verifies each fixture against governance limits
4. **Documentation**: Auto-generates `.txt` files with fixture details
5. **Cleanup**: Temp directories automatically removed

### Binary Content Design

**PNG-like Blob** (`data/tiny.png`):

```typescript
const binaryData = new Uint8Array([
  0x89,
  0x50,
  0x4e,
  0x47,
  0x0d,
  0x0a,
  0x1a,
  0x0a, // PNG signature
  0x00,
  0x00,
  0x00,
  0x0d,
  0x49,
  0x48,
  0x44,
  0x52, // IHDR chunk
  // ... 16x16 dimensions, bit depth, etc
  ...new Array(64).fill(0x00), // Padding to ~100 bytes
]);
```

**Purpose**: Verify that binary data (non-UTF8 bytes) survives tar operations identically. Implementations should extract byte-for-byte matching content.

### Tar Format Overhead

Uncompressed tar archives have significant overhead due to 512-byte block padding:

- **Content size**: ~1KB (5 files totaling ~1000 bytes)
- **Archive size**: 21.5KB (512-byte blocks + metadata)
- **Overhead**: ~20.5KB (95% overhead)

This is why `basic.tar` has a 25KB limit vs 10KB for compressed formats.

## Breaking Changes

None. This release is additive only. Existing fixtures (tar.gz, zip) are regenerated with identical content but now script-driven.

## Deprecations

None.

## Known Issues

None.

## Contributors

Generated by Schema Cartographer ([Claude Code](https://claude.com/claude-code)) under supervision of @3leapsdave.

Co-Authored-By: Schema Cartographer <noreply@3leaps.net>

## What's Next

**v0.2.14** (Planned):

- Fulencode helper library implementations (gofulmen, pyfulmen, tsfulmen)
- Nimbus module specification (cloud storage operations)
- Additional foundry catalog expansions
- Performance benchmark fixtures

**Feedback**: Report issues at https://github.com/fulmenhq/crucible/issues

---

**Full Changelog**: https://github.com/fulmenhq/crucible/blob/main/CHANGELOG.md
