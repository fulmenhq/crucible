# Crucible v0.2.15 - Quality & Reliability Improvements

**Release Date**: 2025-11-16
**Version**: 0.2.15 (SemVer)
**Focus**: Critical bugfixes, type safety improvements, and library extension specifications

---

## üéØ Overview

Version 0.2.15 delivers critical quality and reliability improvements across schema validation, code generation, and library specifications. This release fixes schema mismatches blocking downstream library development, resolves TypeScript type generation bugs, adds comprehensive type instantiation tests to prevent future regressions, and extends the pathfinder library with repository root discovery capabilities.

**Key Highlights**:

- ‚úÖ Fixed critical logging schema middleware config mismatch (blocked gofulmen v0.1.15)
- ‚úÖ Fixed TypeScript code generator array-of-union type wrapping bug
- ‚úÖ Added 20 type instantiation tests for semantic type validation
- ‚úÖ Added Pathfinder repository root discovery specification (328 lines)
- ‚úÖ Documented logging redaction middleware for enterprise features

---

## üêõ Fixed

### TypeScript Code Generation Bugfix - Array-of-Union Type Wrapping

**Problem**: TypeScript code generator produced malformed type definitions for array-of-enum fields.

- Array bracket `[]` was incorrectly applied only to the last union member instead of the entire union
- Example (wrong): `"a" | "b" | "c"[]` (only "c" is array type)
- Example (correct): `("a" | "b" | "c")[]` (entire union is array type)

**Affected Field**: `ValidationResult.checks_performed` in fulpack types

**Impact**: Type checking errors when assigning correctly-typed arrays, forced `as any` workarounds in TSFulmen

**Fix Applied**:

- Updated `inferTypeScriptType()` in `scripts/codegen/generate-fulpack-types.ts`
- Added parentheses wrapping for union types before array bracket: `needsParens ? (${itemType})[] : ${itemType}[]`
- Regenerated TypeScript types for fulpack and fulencode modules
- All type checking passes: `bunx tsc --noEmit` succeeds without errors

**Prevention Measures**:

- Added 20 comprehensive type instantiation tests (`lang/typescript/test/types/fulpack-types.test.ts`)
- Tests verify generated types accept correctly-typed data (catches semantic bugs `tsc` misses)
- Regression tests for array-of-union patterns across all fulpack interfaces
- Tests integrated into CI/CD pipeline via `make test`

**Downstream Impact**: Unblocks TSFulmen v0.1.10+ to remove `as any` workaround

**Files**:

- Generator: `scripts/codegen/generate-fulpack-types.ts` (+7 lines)
- Types: `lang/typescript/src/fulpack/types.ts`, `lang/typescript/src/fulencode/types.ts` (regenerated)
- Tests: `lang/typescript/test/types/fulpack-types.test.ts` (+340 lines, 20 tests)

**Triggered by**: TSFulmen v0.1.9 type checking errors during enum migration

---

### Logging Schema Bugfix - Middleware Configuration Schema Mismatch

**Problem**: `logger-config.schema.json` had two conflicting definitions for middleware configuration.

- **Standalone schema** (`middleware-config.schema.json`): Updated with new `type`, `priority`, `redaction` fields ‚úÖ
- **Embedded definition** in `logger-config.schema.json`: Still used old `name`, `order`, `config` fields ‚ùå

The `logger-config.schema.json` referenced the OLD embedded definition instead of the updated standalone schema, causing validation failures when using the new middleware format.

**Fix Applied**:

- Updated `middleware` array items `$ref` from `#/$defs/middlewareConfig` to `middleware-config.schema.json`
- Removed 30-line embedded `middlewareConfig` definition (conflicted with documented format)
- Standalone schema now single source of truth for middleware configuration

**Impact**: Enables new-style middleware configs with `type`/`priority`/`redaction` fields per documentation

**Downstream Impact**: Unblocks gofulmen v0.1.15 redaction middleware implementation

**Files**: `schemas/observability/logging/v1.0.0/logger-config.schema.json` (+1, -30 lines)

**Reported by**: Foundation Forge (gofulmen agent) during v0.1.15 development

---

## ‚ú® Added

### Pathfinder Repository Root Discovery Specification

**Purpose**: Safe upward filesystem traversal to locate repository markers (`.git`, `go.mod`, `package.json`, etc.)

**Location**: `docs/standards/library/extensions/pathfinder.md` (328 new lines)

**API Specification**:

- `FindRepositoryRoot(startPath, markers, ...opts)` function signature for Go/Python/TypeScript
- Predefined marker sets: `GitMarkers`, `GoModMarkers`, `NodeMarkers`, `PythonMarkers`, `MonorepoMarkers`
- Options: `StopAtFirst`, `MaxDepth`, `Boundary`, `RespectConstraints`, `FollowSymlinks`

**Safety Model**:

- **Default home directory ceiling**: Never traverse above `$HOME` (Linux/macOS) or `%USERPROFILE%` (Windows)
- **Max depth guard**: Default 10 directories upward to prevent runaway traversal
- **PathConstraint integration**: Respects existing application-configured boundaries
- **Platform-specific boundaries**: Windows UNC paths, drive roots, filesystem boundaries handled correctly

**Error Handling**: Schema-compliant errors (`REPOSITORY_NOT_FOUND`, `INVALID_START_PATH`, `TRAVERSAL_LOOP`)

**Use Cases**:

- Finding repository root from nested source directories
- Locating project configuration files (`.fulmen/app.yaml`, `go.mod`)
- Establishing path context for relative imports/paths
- Tool initialization (determining workspace boundaries)

**Eliminates Duplication**: Replaces hand-rolled upward traversal logic in:

- Groningen (`findProjectRoot()`)
- Schema catalog validation
- Identity discovery (`.fulmen/app.yaml` ancestor search)

**Performance**: Expected <5ms typical (3-5 dirs up), <20ms worst case (max depth)

**Cross-Language**: Specification ready for implementation in gofulmen, pyfulmen, tsfulmen

**Triggered by**: Groningen `findProjectRoot()` implementation revealing pattern duplication across repos

---

### Logging Redaction Middleware Documentation

**Purpose**: Comprehensive specification for redaction middleware in logging pipeline

**Location**: `docs/standards/observability/logging.md` (177 new lines)

**Middleware Configuration**:

- **New-style format**: `type` (required), `enabled`, `priority`, type-specific config objects
- **Replaces old format**: `name`, `order`, generic `config` object
- **Supports multiple middleware types**: redaction, filter, augmentation, sampling, custom

**Redaction Specification**:

- **Pattern-based redaction**: Regex support for sensitive data patterns (`SECRET_*`, `TOKEN_*`, `API_KEY_*`)
- **Field-based redaction**: Sensitive field names (password, token, apiKey, credentials)
- **Case-insensitive matching**: Optional `case_insensitive: true` for flexible pattern matching
- **Configurable replacement**: Default `[REDACTED]`, customizable per deployment
- **Priority recommendations**: redaction=10, filter=20, augmentation=30, sampling=40

**Schema References**: Links to `middleware-config.schema.json` and redaction config schema

**Usage Examples**: YAML/JSON config examples with real-world redaction patterns

**Integration**: Works with SIMPLE, STANDARD, ENTERPRISE logging profiles

**Triggered by**: EA Steward memo for gofulmen v0.1.15 enterprise logging features

---

## üîß Technical Details

### Schema Synchronization

- All schema changes synced to Python/TypeScript language wrappers via `make sync`
- Logging schema now matches documentation (`docs/standards/observability/logging.md` lines 204-405)

### Backward Compatibility

- Language implementations MAY support old middleware format during transition period via shims
- Schema enforces new middleware format; old `name`/`order`/`config` fields no longer valid

### Type Safety Improvements

- Type instantiation tests provide semantic validation beyond syntax checking
- Regression tests prevent recurrence of union type wrapping bugs
- Tests run automatically in CI/CD pipeline

---

## üìä Statistics

- **Lines Added**: ~900 (documentation, tests, specifications)
- **Lines Modified**: ~50 (schema fixes, code generation improvements)
- **New Tests**: 20 type instantiation tests
- **Schemas Fixed**: 1 (logger-config.schema.json)
- **Specifications Added**: 1 (Pathfinder repository root discovery)
- **Documentation Added**: 2 (Pathfinder extension, logging redaction middleware)

---

## üîó Downstream Impact

### Unblocks Development

- **gofulmen v0.1.15**: Logging redaction middleware implementation can proceed
- **TSFulmen v0.1.10+**: Can remove `as any` workarounds from fulpack validation results
- **All Fulmen Libraries**: Can implement Pathfinder repository root discovery from canonical spec

### Quality Improvements

- Type instantiation tests prevent semantic type bugs across all code generation
- Schema validation ensures config files match documented middleware format
- Pathfinder specification eliminates duplicated upward traversal implementations

---

## üöÄ Upgrade Guide

### For Schema Consumers

**Logging Middleware Config**:

If you're using logging middleware, update configs to new format:

```yaml
# Old format (no longer valid)
middleware:
  - name: "redact-secrets"
    enabled: true
    order: 10
    config:
      patterns: ["SECRET_*"]

# New format (required)
middleware:
  - type: redaction
    enabled: true
    priority: 10
    redaction:
      patterns: ["SECRET_*"]
      replacement: "[REDACTED]"
```

### For TypeScript Consumers

**Fulpack Types**:

No migration needed if using types correctly. If you had workarounds:

```typescript
// Before (with workaround)
const result: ValidationResult = {
  valid: true,
  errors: [],
  warnings: [],
  entry_count: 5,
  checks_performed: ["structure_valid"] as any, // ‚ùå Workaround
};

// After (no workaround needed)
const result: ValidationResult = {
  valid: true,
  errors: [],
  warnings: [],
  entry_count: 5,
  checks_performed: ["structure_valid"], // ‚úÖ Works correctly
};
```

### For Library Implementers

**Pathfinder Repository Root Discovery**:

When implementing in gofulmen/pyfulmen/tsfulmen:

1. Follow specification in `docs/standards/library/extensions/pathfinder.md` (lines 175-500)
2. Implement safety boundaries (home directory ceiling, max depth)
3. Use predefined marker sets for consistency
4. Integrate with PathConstraint if configured
5. Add comprehensive tests (boundary, marker matching, platform compatibility)

---

## üìö Related Documentation

- [Pathfinder Extension Specification](docs/standards/library/extensions/pathfinder.md)
- [Logging Standard](docs/standards/observability/logging.md)
- [Fulpack Module Standard](docs/standards/library/modules/fulpack.md)
- [Code Generation Template Standard](docs/standards/code-generation-template-standard.md)
- [Portable Testing Practices](docs/standards/testing/portable-testing-practices.md)

---

## üôè Credits

**Triggered by**:

- Foundation Forge (gofulmen agent) - Logging schema bug discovery
- EA Steward - Logging redaction middleware requirements
- TSFulmen development - TypeScript type generation bug discovery
- Groningen development - Pathfinder repository root discovery need

**Developed by**: Schema Cartographer under supervision of @3leapsdave

---

## üîú Next Steps

### v0.2.16 Planning

Potential focus areas:

- Additional type instantiation tests for fulencode types
- Pathfinder implementation in gofulmen v0.1.15+
- Logging middleware implementation in all three languages
- Cross-language parity testing for generated types

---

**Full Changelog**: [CHANGELOG.md](../CHANGELOG.md)
**Previous Release**: [v0.2.14](v0.2.14.md)

---

<div align="center">

‚ö° **Quality First. Scale Forever.** ‚ö°

</div>
