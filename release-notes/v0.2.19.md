# Crucible v0.2.19 - DevSecOps Secrets Schema Hardening

**Release Date**: 2025-11-19
**Version**: 0.2.19 (SemVer)
**Focus**: Security hardening with size limits and enhanced metadata for secrets schema

---

## üéØ Overview

Version 0.2.19 hardens the DevSecOps secrets schema (v1.0.0) with defensive size limits and optional enterprise metadata fields. This update provides DoS protection while maintaining backwards compatibility, enabling fulmen-secrets and downstream tools to benefit from enhanced credential tracking before public release.

**Key Highlights**:

- ‚úÖ Six defensive size limits for DoS protection and OS alignment
- ‚úÖ Nine optional metadata fields for rotation tracking, service integration, and compliance
- ‚úÖ Backwards compatible - existing valid secrets files continue to work
- ‚úÖ Generous limits (10-100x typical use cases) to avoid blocking legitimate workflows
- ‚úÖ Pre-release timing - safe to enhance v1.0.0 schema before fulmen-secrets ships

---

## üîí Changed

### DevSecOps Secrets Schema Hardening

**Motivation**: Strengthen secrets schema v1.0.0 with defensive constraints and enterprise metadata before fulmen-secrets release; prevent DoS attacks from unbounded values while supporting compliance workflows.

#### Size Limits Added (DoS Protection)

**All limits are generous** (10-100x typical use cases) to avoid blocking legitimate workflows:

| Field                                         | Limit             | Rationale                                               |
| --------------------------------------------- | ----------------- | ------------------------------------------------------- |
| **Credential values** (`value`)               | 65,536 chars      | 64KB max, UTF-8 encoded; generous for keys/certs/tokens |
| **External refs** (`ref`)                     | 2,048 chars       | Printable ASCII only; covers vault URIs, ARNs           |
| **Descriptions** (all levels)                 | 4,096 chars       | File, project, and credential descriptions              |
| **Credential key names** (env vars)           | 255 chars         | OS environment variable name limit (POSIX standard)     |
| **Projects per file** (`maxItems`)            | 256 projects      | Monorepo support without unbounded growth               |
| **Credentials per project** (`maxProperties`) | 1,024 credentials | Enterprise-scale projects; prevents accidental bloat    |

**Design Philosophy**:

- **Generous defaults**: Limits are 10-100x typical use cases (average project has 10-50 credentials)
- **DoS prevention**: Caps prevent malicious/accidental resource exhaustion
- **OS alignment**: Env var name limit matches POSIX/Linux/macOS standards (255 chars)
- **Audit-friendly**: Large description limits (4KB) support compliance documentation

**Override Strategy** (rare):

1. Split large files into multiple project-scoped files (recommended)
2. Use external references (`ref`) for oversized values (e.g., large certificates ‚Üí vault)
3. Contact Crucible maintainers if limits are blocking legitimate enterprise use

#### Enhanced Metadata Fields (Optional)

**All fields are optional** to maintain backwards compatibility. Existing secrets files require no changes.

**Rotation Tracking** (3 fields):

| Field            | Type              | Description                                      |
| ---------------- | ----------------- | ------------------------------------------------ |
| `last_rotated`   | string (ISO 8601) | Timestamp when credential was last rotated       |
| `next_rotation`  | string (ISO 8601) | Timestamp when credential should next be rotated |
| `rotation_count` | integer           | Number of times credential has been rotated (‚â•0) |

**Service Integration** (3 fields):

| Field            | Type         | Description                                                    |
| ---------------- | ------------ | -------------------------------------------------------------- |
| `service_name`   | string       | External service name (e.g., `Stripe`, `GitHub API`, `AWS S3`) |
| `service_url`    | string (URI) | Service URL (e.g., `https://api.stripe.com`)                   |
| `required_scope` | string       | OAuth/API scope (e.g., `repo:write`, `payments:read`)          |

**Compliance & Environment** (3 fields):

| Field             | Type          | Description                      | Allowed Values                                               |
| ----------------- | ------------- | -------------------------------- | ------------------------------------------------------------ |
| `compliance_tags` | array[string] | Compliance framework tags        | `pci-dss`, `soc2`, `hipaa`, etc. (max 20 items)              |
| `environment`     | string (enum) | Deployment environment           | `production`, `staging`, `development`, `test`, `qa`, `demo` |
| `tier`            | string (enum) | Service tier / criticality level | `critical`, `high`, `medium`, `low`                          |

**Use Cases**:

- **Rotation tracking**: Automate credential rotation workflows, track compliance with rotation policies
- **Service integration**: Document API relationships, generate dashboards showing credential dependencies
- **Compliance**: Tag PCI-DSS/SOC2/HIPAA credentials, filter by environment/tier for audit reports

#### Files Updated

**Schema**:

- `schemas/devsecops/secrets/v1.0.0/secrets.schema.json`:
  - Added size constraints (maxLength, maxItems, maxProperties) to all relevant fields
  - Added 9 optional metadata fields to `CredentialMetadata` definition
  - Added `pattern` constraint for `ref` field (printable ASCII only)
  - Added `contentEncoding: "utf-8"` for `value` field

**Configuration Defaults**:

- `config/devsecops/secrets/v1.0.0/defaults.yaml`:
  - Added header comment documenting all size limits with rationale
  - Enhanced Example 2 (`STRIPE_API_KEY` credential) to showcase all new metadata fields
  - Demonstrates rotation tracking, service integration, compliance tags, environment, tier

**Documentation**:

- `docs/standards/devsecops/project-secrets.md`:
  - Added "Size Limits & DoS Protection" section (lines 66-92):
    - Table of all limits with rationales
    - Design philosophy explanation
    - Override strategy for edge cases
  - Expanded "Metadata Object (Optional)" section (lines 117-148):
    - Split into three tables: Core Fields, Service Integration Fields, Compliance & Environment Fields
    - Added descriptions and examples for all 9 new fields
    - Documented enum values for `environment` and `tier`

**Language Wrappers** (synced via `make sync`):

- TypeScript: `lang/typescript/schemas/`, `lang/typescript/config/`, `lang/typescript/docs/`
- Python: `lang/python/schemas/`, `lang/python/config/`, `lang/python/docs/`
- Go: Embedded at root (no sync needed)

**Version Files**:

- `VERSION` ‚Üí 0.2.19
- `package.json` ‚Üí 0.2.19
- `lang/typescript/package.json` ‚Üí 0.2.19
- `lang/python/pyproject.toml` ‚Üí 0.2.19

---

## üîç Implementation Highlights

### Size Limit Rationale

**Problem**: Unbounded fields create DoS vectors:

```yaml
# ‚ùå Malicious/accidental DoS attack
credentials:
  HUGE_VALUE:
    type: password
    value: "[10MB of garbage data]" # Crashes parser, exhausts memory
```

**Solution**: Generous but defensive limits:

```yaml
# ‚úÖ 64KB limit allows legitimate large values (certificates, JWTs, etc.)
credentials:
  TLS_CERTIFICATE:
    type: password
    value: "[5KB PEM-encoded cert]" # Well within 64KB limit
```

**Impact**:

- Prevents accidental bloat from copy-paste errors
- Blocks malicious payloads designed to exhaust memory/disk
- Aligns with OS limits (env var names: 255 chars POSIX standard)

### Metadata Field Design

**Rotation Tracking Example**:

```yaml
STRIPE_API_KEY:
  type: api_key
  value: sk_live_abc123def456_not_real
  metadata:
    created: "2025-01-15T10:00:00Z"
    last_rotated: "2025-10-15T10:00:00Z"
    next_rotation: "2026-01-15T10:00:00Z"
    rotation_count: 3
  rotation:
    interval: 90d
    method: auto
```

**Benefits**:

- fulmen-secrets can warn when `next_rotation` approaching
- Audit logs track `rotation_count` for compliance
- Dashboards visualize rotation cadence across all credentials

**Compliance Tracking Example**:

```yaml
DATABASE_PASSWORD:
  type: password
  value: super_secure_password_not_real
  metadata:
    compliance_tags:
      - pci-dss
      - soc2
    environment: production
    tier: critical
    owner: platform-team
```

**Benefits**:

- Filter PCI-DSS credentials for quarterly audits
- Generate compliance reports grouping by `tier` (critical/high/medium/low)
- Identify production credentials requiring enhanced rotation policies

---

## üõ°Ô∏è Backwards Compatibility

### Safe to Upgrade

**No breaking changes**:

- All size limits are generous (10-100x typical use cases)
- All metadata fields are optional
- Existing valid secrets files continue to validate

**Example - Existing file (v0.2.18) still valid in v0.2.19**:

```yaml
schema_version: v1.0.0
projects:
  - project_slug: backend-api
    credentials:
      DATABASE_URL:
        type: password
        value: postgres://localhost:5432/db # Still valid, well under 64KB limit
```

**Example - New file leveraging v0.2.19 enhancements**:

```yaml
schema_version: v1.0.0
projects:
  - project_slug: backend-api
    credentials:
      DATABASE_URL:
        type: password
        value: postgres://localhost:5432/db
        metadata: # Optional - can omit entirely
          environment: production
          tier: critical
```

---

## üé¨ Downstream Impact

### Unblocked Workflows

**fulmen-secrets** (unreleased):

- Rotation warnings based on `next_rotation` field
- Compliance filtering using `compliance_tags`, `environment`, `tier`
- Service dependency graphs using `service_name`, `service_url`
- Validation prevents oversized values before encryption

**gofulmen** (schema embed):

- Updated schema available on Crucible v0.2.19 sync
- Can enforce limits in validation workflows
- Metadata available for custom tooling

**pyfulmen** (schema embed):

- Updated schema available on Crucible v0.2.19 sync
- Can leverage metadata for compliance dashboards

### Migration Guide

**For existing secrets files**:

No action required. All existing files remain valid.

**For new secrets files**:

Optionally add metadata fields to enhance tracking:

```yaml
STRIPE_API_KEY:
  type: api_key
  value: sk_live_...
  metadata:
    last_rotated: "2025-10-15T10:00:00Z" # Optional
    service_name: Stripe # Optional
    environment: production # Optional
```

**For oversized values** (rare):

If you hit a limit, use one of these strategies:

1. **Split files**: Separate large monorepo into multiple project files
2. **External refs**: Move large values (e.g., multi-MB certificates) to vault
3. **Contact maintainers**: If legitimate enterprise use case blocked

---

## üìã Quality Gates

All quality gates passed:

- ‚úÖ **Schema Validation**: 76 schemas validated (meta + semantic)
- ‚úÖ **Code Generation**: Exit codes, fulpack, fulencode up-to-date
- ‚úÖ **Sync**: TypeScript, Python wrappers updated
- ‚úÖ **Build**: Go, TypeScript, Python - all passed
- ‚úÖ **Linting**: 0 issues, 100% health (goneat, biome, ruff)
- ‚úÖ **Tests**: Go (0.4s), TypeScript (36 tests), Python (10 tests) - all passed
- ‚úÖ **Type Checking**: TypeScript clean

---

## üéØ Related

- **Feature Brief**: `.plans/active/v0.2.19/devsecops-secrets-safety-update-brief.md`
- **Secrets Schema**: `schemas/devsecops/secrets/v1.0.0/secrets.schema.json`
- **Secrets Standard**: `docs/standards/devsecops/project-secrets.md`
- **Defaults Config**: `config/devsecops/secrets/v1.0.0/defaults.yaml`
- **Previous Release**: v0.2.18 (HTTP Server Metrics Taxonomy)

---

**Generated by Schema Cartographer (@schema-cartographer) under supervision of @3leapsdave**
