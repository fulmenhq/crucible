# Release Notes: v0.2.12

**Date**: 2025-11-14

Encoding and testing practices release delivering Common-tier encoding/decoding operations with security-first design and comprehensive CLI testing isolation patterns across all supported languages.

## Highlights

- **Fulencode Module Complete**: Common-tier encoding/decoding (Base64, Base32, Hex), UTF detection, Unicode normalization with 14-metric telemetry and security protections
- **Language-Specific Testing Patterns**: CLI testing isolation guidance for all supported languages (Go Cobra, Python Typer/Click, TypeScript Commander/oclif, Rust, C#)
- **Cross-Language Type Generation**: Complete type generation infrastructure for fulencode with Go, Python, TypeScript support
- **Helper Library Feedback Integration**: All three helper library teams (gofulmen, pyfulmen, tsfulmen) reviewed and approved specifications

## What's New

### 1. Fulencode Module Complete

Complete Common-tier module for canonical encoding/decoding operations with security-first design, explicit transformation algorithms, and comprehensive telemetry.

#### Module Specification

**Location**: `docs/standards/library/modules/fulencode.md` (4,124 lines, 97 sections)

**Core Operations**:

- `encode(data, format, options)` - Binary to text (Base64, Base32, Hex)
- `decode(data, format, options)` - Text to binary with validation
- `detect(reader, options)` - Character encoding detection with confidence scoring
- `normalize(text, profile)` - Unicode normalization (NFC, NFD, NFKC, NFKD + custom profiles)
- `bom(action, reader)` - BOM handling (inspect, remove, inject)

**Canonical Façade**: Single API surface for all encoding operations across helper libraries, following the Canonical Façade Principle from v0.2.10.

**Integration Examples**: 8 complete examples showing integration with Fulpack (file name normalization), Nimbus (cloud payload encoding), Pathfinder (manifest encoding).

#### Security Model

**Mandatory Protections**:

- Buffer overflow protection with configurable limits
- Encoding bomb detection (expansion ratio monitoring)
- Normalization attack prevention (zero-width character rejection, combining mark limits)
- UTF-8 validation (reject overlong encodings, surrogates, invalid sequences)
- Safe defaults (strict validation mode, error on ambiguous input)

**Security Metrics**:

- `fulencode.security.violations_total` - Counter for detected attacks
- `fulencode.corrections.total` - Counter for automatic corrections
- Alert on encoding bombs: `violations_total{type="encoding_bomb"}` > 0

#### Taxonomies and Schemas

**7 Schemas Created and Validated**:

**Data Structure** (1 file):

- `schemas/library/fulencode/v1.0.0/fulencode-config.schema.json` - Configuration schema

**Taxonomies** (6 files):

- **Encoding Families** (`schemas/taxonomy/library/fulencode/encoding-families/v1.0.0/`):
  - `families.schema.json` - JSON Schema for encoding families taxonomy
  - `families.yaml` - 12 Common-tier formats: base64, base64url, base64_raw, base32, base32hex, hex, utf-8, utf-16le, utf-16be, iso-8859-1, cp1252, ascii
- **Normalization Profiles** (`schemas/taxonomy/library/fulencode/normalization-profiles/v1.0.0/`):
  - `profiles.schema.json` - JSON Schema for normalization profiles taxonomy
  - `profiles.yaml` - 8 profiles: NFC, NFD, NFKC, NFKD + 4 custom (safe_identifiers, search_optimized, filename_safe, legacy_compatible)
- **Detection Confidence** (`schemas/taxonomy/library/fulencode/detection-confidence/v1.0.0/`):
  - `levels.schema.json` - JSON Schema for confidence levels taxonomy
  - `levels.yaml` - 3 levels: HIGH (≥90%), MEDIUM (50-89%), LOW (<50%)

**Validation**: All 74 repository schemas meta-validate (includes fulencode).

#### Custom Normalization Profiles

**Explicit Transformation Algorithms** (lines 299-429 in module spec):

**1. safe_identifiers**:

- Step 1: Apply NFKC normalization
- Step 2: Reject zero-width characters (U+200B, U+200C, U+200D, U+FEFF)
- Step 3: Check combining marks limit (max 3 by default, prevent stacking attacks)
- Step 4: Validate character categories (only Lu, Ll, Lt, Lm, Lo, Nd, Pc allowed)

**2. search_optimized**:

- Step 1: Apply NFKD normalization
- Step 2: Strip accents (remove combining marks)
- Step 3: Case folding (use `str.casefold()`)
- Step 4: Remove punctuation (Unicode categories P, S)
- Step 5: Compress whitespace (collapse multiple spaces)

**3. filename_safe**:

- Step 1: Apply NFC normalization (macOS/Windows compatibility)
- Step 2: Reject control characters (0x00-0x1F, 0x7F-0x9F)
- Step 3: Reject path separators (/, \, null)
- Step 4: Normalize spaces (collapse and trim)
- Step 5: Optional - reject Windows reserved names (CON, PRN, AUX, etc.)

**4. legacy_compatible**:

- Step 1: Apply NFC normalization
- Step 2: Optional transliteration (é→e, ñ→n, etc.) **LOSSY**
- Step 3: Optional - strip non-ASCII (< 0x80 only)

**Implementation Requirement**: All profiles MUST raise `FulencodeError` on violations. Track semantic changes in `NormalizationResult.semantic_changes[]`.

#### Detection Algorithm

**4-Step Minimum for Common Tier** (lines 857-934 in module spec):

**Step 1: BOM Detection**:

- Check first 2-4 bytes for UTF-8/UTF-16/UTF-32 BOM signatures
- Confidence: HIGH (if BOM present)

**Step 2: UTF-8 Validation**:

- Validate all bytes form legal UTF-8 sequences
- Check for overlong encodings and surrogates
- Confidence: HIGH (if all bytes valid UTF-8)

**Step 3: NULL Pattern Detection**:

- Scan for regular NULL byte patterns indicating UTF-16LE/BE
- Confidence: HIGH (if consistent NULL pattern)

**Step 4: ASCII Fallback**:

- If all bytes < 0x80, return "utf-8" with LOW confidence
- Confidence: LOW (ambiguous between ASCII and UTF-8)

**Common Tier Limitations**:

- NO statistical byte frequency analysis (requires lookup tables/ML)
- NO CP1252 vs ISO-8859-1 disambiguation
- NO CJK encoding detection
- → All deferred to `fulencode-detect-pro` (Specialized tier)

#### Code Generation Infrastructure

**Generator**: `scripts/codegen/generate-fulencode-types.ts` (follows fulpack v0.2.11 pattern)

**Verifier**: `scripts/codegen/verify-fulencode-types.ts`

- Drift detection
- Compilation checks (tsc, go build, python -m py_compile)
- Integrated into `make verify-codegen`

**Metadata**: `scripts/codegen/fulencode-types/metadata.json`

- Multi-language configuration
- Template paths for Python (Jinja2), Go (EJS), TypeScript (EJS)

**Makefile Integration**:

```bash
make codegen-fulencode     # Generate types for all languages
make verify-codegen        # Verify all codegen (includes fulencode)
```

#### Generated Types

**Go** (`fulencode/types.go`):

```go
type EncodingFormat string

const (
    EncodingFormatBase64    EncodingFormat = "base64"
    EncodingFormatBase32    EncodingFormat = "base32"
    EncodingFormatHex       EncodingFormat = "hex"
    // ... 9 more formats
)

func ValidateEncodingFormat(value EncodingFormat) error {
    // Validation logic
}
```

**Python** (`lang/python/src/crucible/fulencode/enums.py`):

```python
from enum import Enum

class EncodingFormat(str, Enum):
    BASE64 = "base64"
    BASE32 = "base32"
    HEX = "hex"
    # ... 9 more formats
```

**TypeScript** (`lang/typescript/src/fulencode/types.ts`):

```typescript
export type EncodingFormat = "base64" | "base32" | "hex";
// ... 9 more formats
```

**Verification**: All types compile cleanly with zero errors, pass drift detection.

#### Telemetry Specification

**14 Metrics Across 6 Categories**:

**Core Operations** (2 metrics):

- `fulencode.operation.duration_seconds` (Histogram) - Operation latency
- `fulencode.operation.total` (Counter) - Operation count by format/status

**Data Volume** (2 metrics):

- `fulencode.bytes.processed` (Histogram) - Bytes processed per operation
- `fulencode.expansion.ratio` (Histogram) - Encoding expansion ratio

**Detection** (2 metrics):

- `fulencode.detect.result_total` (Counter) - Detection results by encoding/confidence
- `fulencode.detect.duration_seconds` (Histogram) - Detection latency

**Normalization** (2 metrics):

- `fulencode.normalize.total` (Counter) - Normalization operations by profile
- `fulencode.normalize.semantic_changes_total` (Counter) - Semantic changes detected

**Security** (2 metrics):

- `fulencode.security.violations_total` (Counter) - Security violations by type
- `fulencode.corrections.total` (Counter) - Automatic corrections applied

**BOM Handling** (2 metrics):

- `fulencode.bom.operations_total` (Counter) - BOM operations by action
- `fulencode.bom.mismatches_total` (Counter) - BOM/content encoding mismatches

**Implementation Checklist** (lines 3480-3527 in module spec):

- Complete table mapping all 14 metrics to operations
- Required labels documented for each metric
- "When to Emit" column with timing guidance
- Test validation pattern included

#### Dependency Guidance

**Common Tier (Phase 1) - Minimal Dependencies**:

**Python**: Pure stdlib - **Zero PyPI packages**

- Modules: `base64`, `binascii`, `unicodedata`, `codecs`

**TypeScript**: Pure stdlib - **Zero npm packages**

- APIs: `Buffer`, `String.prototype.normalize()`

**Go**: Stdlib + `golang.org/x/text/unicode/norm`

- Extended stdlib for Unicode normalization (already vendored)
- Note: Go stdlib lacks native Unicode normalization; `x/text` is de facto standard
- Encoding operations use pure stdlib (`encoding/base64`, `encoding/hex`, `unicode/utf8`)

**Clarification** (per gofulmen feedback): "Zero external deps" means zero package manager dependencies (PyPI/npm). Go's `golang.org/x/text` is acceptable as extended stdlib.

**Specialized Tier (Phase 3) - Optional Dependencies**:

- `fulencode-detect-pro` - Statistical/ML detection (chardet, jschardet)
- `fulencode-base58` - Base58/Base58Check encoding
- `fulencode-base85` - Base85/Ascii85/Z85 encoding
- `fulencode-legacy-cjk` - CJK legacy encodings (Shift-JIS, GB2312, Big5)
- `fulencode-legacy-mainframe` - EBCDIC variants
- `fulencode-legacy-european` - ISO-8859-2 through 15, KOI8-R

**Packaging Examples**:

Python (`pyproject.toml`):

```toml
[project.optional-dependencies]
fulencode-detect-pro = ["chardet>=5.0.0", "charset-normalizer>=3.0.0"]
fulencode-base58 = ["base58>=2.1.0"]

dataeng = ["chardet>=5.0.0", "base58>=2.1.0"]  # Convenience bundle
```

#### Helper Library Feedback

**All 3 Teams Reviewed and Approved**:

**tsfulmen (EA Steward)** - 6 items addressed:

- Detection scope clarification (Common vs Specialized tier)
- Dependency guidance for optional TypeScript dependencies
- Generated types integration patterns
- Telemetry adoption checklist
- Streaming APIs dependency on Nimbus
- Packaging examples

**pyfulmen** - 5 items addressed:

- Minimum detection algorithm for Common tier (4-step algorithm with pseudocode)
- Normalization profile transformation rules (step-by-step Python algorithms)
- Telemetry map (operation → metric table)
- Packaging guidance for extras naming (`fulencode-{capability}` pattern)
- Pilot timeline coordination

**gofulmen** - Dependency clarification:

- Clarified Go's `golang.org/x/text` as extended stdlib (acceptable exception)
- Updated terminology from "zero external deps" to "minimal dependencies"
- Documented per-language dependency philosophy

**Response Documents**:

- `.plans/active/v0.2.12/FULENCODE-EA-STEWARD-RESPONSE.md`
- `.plans/active/v0.2.12/FULENCODE-PYFULMEN-RESPONSE.md`
- `.plans/active/v0.2.12/FULENCODE-GOFULMEN-RESPONSE.md`

#### Spec Highlights - Key Navigation

Added to feature brief for easier navigation:

- **§ Generated Types Integration** (lines 67-147): Import patterns for all 3 languages
- **§ Taxonomy-Driven Design** (lines 148+): Encoding families, profiles, confidence levels
- **§ API Operations**: Core verbs with code examples
- **§ Custom Profile Transformation Rules** (lines 299-429): Step-by-step algorithms
- **§ Minimum Detection Algorithm** (lines 857-934): 4-step Common tier algorithm
- **§ Telemetry Implementation Checklist** (lines 3480-3527): Metric mapping table
- **§ Security Guidance**: Buffer limits, encoding bombs, normalization attacks
- **§ Integration Examples**: Fulpack, Nimbus, Pathfinder patterns

### 2. Language-Specific Testing Patterns

CLI testing isolation guidance for all supported languages to prevent state pollution between tests and ensure deterministic execution.

#### Core Documents

**Language-Specific Patterns** (`docs/standards/testing/language-testing-patterns.md`):

- **Go - Cobra Command Isolation**: Factory functions, flag reset helpers, test isolation pattern
- **Python - Typer/Click CLI Isolation**: Application factory pattern, contextvars reset, runner helpers
- **TypeScript - Commander/oclif Isolation**: Factory pattern, process state mocking, output capture
- **Rust - Clap/Tokio CLIs**: Builder functions, async isolation, tokio test configuration
- **C# - System.CommandLine**: CommandFactory pattern, dependency injection, output capture

**Testing Standards Index** (`docs/standards/testing/README.md`):

- Navigation index for all testing guidance documents
- Quick-reference table linking portable-testing-practices and language-testing-patterns

#### Go - Cobra Command Isolation

**Use Case**: CLI applications built with spf13/cobra (e.g., goneat, workhorse forges) where tests were flaking because `rootCmd` singletons retain state between runs.

**Pattern Overview** (from `goneat/.plans/memos/crucible/cobra-test-isolation-pattern.md`):

**1. Factory Function** - Replace package-level singleton:

```go
func newRootCommand() *cobra.Command { ... }
var rootCmd = newRootCommand()
func registerSubcommands(cmd *cobra.Command) { ... }
func init() { registerSubcommands(rootCmd) }
```

**2. Flag Reset Helpers** - Reset package-level flag variables before each test:

```go
func resetDoctorFlags() {
    flagDoctorInstall = false
    flagDoctorScope = "all"
    // ... reset other flags
}
```

**3. Test Helper** - Centralize execution:

```go
func execCmd(t *testing.T, args []string) (string, error) {
    resetDoctorFlags()
    cmd := newRootCommand()
    registerSubcommands(cmd)
    cmd.SetArgs(args)
    return captureOutput(cmd.Execute)
}
```

**4. Shared Cleanup** - Use `t.Cleanup` to restore global state.

**Anti-Patterns to Avoid**:

- Reusing the global `rootCmd` in tests
- Allowing subcommands to self-register in their `init()` (breaks factory approach)
- Failing to reset package-level flag variables between tests

**Adoption**: Use this pattern in any Cobra-based Fulmen CLI to ensure `go test ./...` behaves the same regardless of test order.

#### Python - Typer/Click CLI Isolation

**Pattern**:

1. **Application Factory** - Export `def create_app() -> typer.Typer` that builds the CLI
2. **Contextvars Reset** - Use fixtures to reset global context vars or caches
3. **Runner Helpers** - Use `typer.testing.CliRunner` with helper functions that inject environment variables, temp directories, and mock config paths

#### TypeScript - Commander / oclif Isolation

**Pattern**:

1. **Factory** - Export `function buildProgram(): Command` returning a fresh Commander instance
2. **Mock Process State** - Helper to capture `process.stdout`/`stderr` and reset `process.argv`, `env`, and timer mocks in `afterEach`
3. **Portability** - Use `get-port` for server tests; guard real network calls with feature flags

#### Rust - Clap/Tokio CLIs

**Pattern** (for upcoming `rsfulmen` modules):

1. **Builder Function** - `fn build_cli() -> Command` returns new clap command each time
2. **Async Isolation** - Use `tokio::test(flavor = "multi_thread", worker_threads = 1)` for deterministic scheduler
3. **Temp Directories** - Use `tempfile::TempDir` with automatic cleanup

#### C# - System.CommandLine / Spectre.Console.Cli

**Pattern** (for planned `csfulmen` modules):

1. **CommandFactory** - Provide `Command CreateRootCommand()` and register subcommands centrally
2. **Dependency Injection** - Avoid static singletons; wire services through DI containers per test scope
3. **Output Capture** - Use `System.IO.StringWriter` and dependency-injected console abstractions

#### Cross-References Added

**Coding Standards Updated**:

- **Go** (`docs/standards/coding/go.md`): Added CLI Testing section referencing Cobra command isolation pattern
- **Python** (`docs/standards/coding/python.md`): Added CLI Testing section referencing Typer/Click application factory pattern
- **TypeScript** (`docs/standards/coding/typescript.md`): Added CLI Testing section referencing Commander/oclif factory pattern

**Cross-Language Coding Standards** (`docs/standards/coding/README.md`):

- Added § 8.4 Additional Testing Guidance with links to testing standards directory

## Migration Guide

### For Helper Library Implementers

**Fulencode Implementation Priorities**:

**Phase 1 (MVP - Common tier)**:

1. Core encode/decode operations (Base64, Base32, Hex)
2. Basic detection (BOM + UTF-8 validation only)
3. Unicode normalization (NFC, NFD)
4. Import generated types from Crucible

**Phase 2 (Enhanced features)**:

1. BOM handling (inspect/remove/inject)
2. Extended normalization profiles (NFKC, NFKD, safe_identifiers, etc.)
3. Telemetry integration (14 metrics - see checklist in module spec)

**Phase 3 (Integration features)**:

1. Streaming adapters (requires Nimbus finalization)
2. Fulhash integration (checksum calculation)
3. Specialized extensions (detect-pro, base58, legacy encodings)

**Generated Types Usage**:

TypeScript:

```typescript
import type {
  EncodingFormat,
  NormalizationProfile,
} from "@fulmenhq/crucible/fulencode/types";

export function encode(data: Uint8Array, format: EncodingFormat): string {
  // Implementation uses generated types for validation
}
```

Python:

```python
from crucible.fulencode import EncodingFormat, NormalizationProfile

def encode(data: bytes, format: EncodingFormat) -> str:
    # Implementation uses generated enums
```

Go:

```go
import "github.com/fulmenhq/crucible/fulencode"

func Encode(data []byte, format fulencode.EncodingFormat) (string, error) {
    if err := fulencode.ValidateEncodingFormat(format); err != nil {
        return "", err
    }
    // ...
}
```

### For Test Authors

**Apply CLI Testing Isolation Patterns**:

1. **Review**: Read `docs/standards/testing/language-testing-patterns.md` for your language
2. **Factory Pattern**: Implement command factory functions (no global singletons)
3. **Reset Helpers**: Add flag/state reset helpers for each test
4. **Test Helper**: Centralize command execution with built-in cleanup
5. **Cleanup**: Use language-specific cleanup mechanisms (`t.Cleanup`, fixtures, `afterEach`)

**Language-Specific**:

- Go Cobra: Check `docs/standards/coding/go.md#portable-testing`
- Python Typer/Click: Check `docs/standards/coding/python.md#portable-testing`
- TypeScript Commander/oclif: Check `docs/standards/coding/typescript.md#portable-testing`

## Technical Details

### Fulencode Code Generation Workflow

```bash
# Generate types for all languages
make codegen-fulencode

# Verify types are up-to-date (includes compilation checks)
make verify-codegen

# Generate manually with script
bun run scripts/codegen/generate-fulencode-types.ts --all --format
bun run scripts/codegen/generate-fulencode-types.ts --lang typescript
```

### Testing Pattern Discovery

Teams discovering new language-specific testing patterns should:

1. Document pattern in internal memos (e.g., `.plans/memos/crucible/`)
2. Add subsection to `docs/standards/testing/language-testing-patterns.md`
3. Reference canonical memos or design docs
4. Update relevant coding standard with cross-reference

## Breaking Changes

None. This release is additive only.

## Deprecations

None.

## Known Issues

None.

## Contributors

Generated by Schema Cartographer ([Claude Code](https://claude.com/claude-code)) under supervision of @3leapsdave.

Co-Authored-By: Schema Cartographer <noreply@3leaps.net>

## What's Next

**v0.2.13** (Planned):

- Fulencode helper library implementations (gofulmen, pyfulmen, tsfulmen)
- Nimbus module specification (cloud storage operations)
- Module registry updates (platform-modules/foundry-catalogs split refinement)
- Additional code generation patterns

**Feedback**: Report issues at https://github.com/fulmenhq/crucible/issues

---

**Full Changelog**: https://github.com/fulmenhq/crucible/blob/main/CHANGELOG.md
