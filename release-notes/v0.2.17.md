# Crucible v0.2.17 - DevSecOps Secrets Schema Enhancement

**Release Date**: 2025-11-17
**Version**: 0.2.17 (SemVer)
**Focus**: Rich credential objects with lifecycle management for enterprise secrets

---

## üéØ Overview

Version 0.2.17 enhances the DevSecOps secrets schema with structured credential objects, smart masking, lifecycle metadata, and rotation policies. This update aligns Crucible with fulmen-secrets v0.1.1 pre-release features, enabling enterprise-grade credential management with type-aware masking, expiry tracking, and rotation workflows.

**Key Highlights**:

- ‚úÖ Structured credential objects replace flat string values
- ‚úÖ Smart masking by credential type (api_key, password, token)
- ‚úÖ Lifecycle metadata (created, expires, purpose, tags, owner)
- ‚úÖ Rotation policies (interval, method: auto/manual)
- ‚úÖ External reference support (vault://, aws-secrets://)
- ‚úÖ Domain consistency fix (schemas.fulmenhq.dev)

---

## üîÑ Changed

### DevSecOps Secrets Schema - Rich Credential Objects with Lifecycle Management

**Motivation**: Align Crucible SSOT with fulmen-secrets v0.1.1 features; enable enterprise credential management with structured objects, metadata tracking, and rotation policies.

#### Top-Level Schema Changes

**Added Fields**:

| Field         | Type   | Description                                         |
| ------------- | ------ | --------------------------------------------------- |
| `env_prefix`  | string | Global environment variable prefix for all projects |
| `description` | string | Multi-line description of the secrets file          |

**Benefits**:

- Global `env_prefix` reduces repetition across projects
- Multi-line descriptions support contact info, purpose, usage notes

#### Project-Level Changes

**Updated `project_slug` Pattern**:

- **Old**: `^[a-z0-9]+(-[a-z0-9]+)*$` (hyphens only)
- **New**: `^[a-z0-9]([a-z0-9_-]*[a-z0-9])?$` (hyphens + underscores)
- **Valid examples**: `backend-api`, `api_staging`, `worker-dev`, `my_service-v2`

**Added Fields**:

| Field         | Type   | Description                           |
| ------------- | ------ | ------------------------------------- |
| `description` | string | Multi-line description of the project |

**Breaking Change**: Renamed `secrets` ‚Üí `credentials`

- Old field name: `secrets` (flat string map)
- New field name: `credentials` (structured credential objects)
- **Impact**: Safe pre-release change - fulmen-secrets not yet released

#### Credential Object Structure (New)

**Replaced**: Flat string map (`{ "API_KEY": "value" }`)
**With**: Structured credential objects with rich metadata

**Required Fields**:

| Field  | Type | Description                                        |
| ------ | ---- | -------------------------------------------------- |
| `type` | enum | Credential type: `api_key`, `password`, or `token` |

**Value/Reference (Mutually Exclusive)**:

| Field   | Type   | Description                                      |
| ------- | ------ | ------------------------------------------------ |
| `value` | string | Inline plaintext credential value                |
| `ref`   | string | External reference (e.g., `vault://secret/path`) |

**Note**: Exactly one of `value` or `ref` must be provided (enforced via oneOf constraint)

**Optional Fields**:

| Field         | Type   | Description                        |
| ------------- | ------ | ---------------------------------- |
| `description` | string | Human-readable purpose description |
| `metadata`    | object | Lifecycle metadata (see below)     |
| `rotation`    | object | Rotation policy (see below)        |

#### Smart Masking by Credential Type

Credential types determine masking behavior for logs, debugging, and output:

| Type       | Use Case                    | Masking Behavior                 | Examples                   |
| ---------- | --------------------------- | -------------------------------- | -------------------------- |
| `api_key`  | External service API keys   | Show prefix: `sk_live_...xyz`    | Stripe, GitHub, AWS keys   |
| `token`    | Auth tokens, JWTs           | Show suffix: `...1234`           | Bearer tokens, JWT secrets |
| `password` | Passwords, DB URLs, secrets | Full redaction: `***REDACTED***` | Database passwords, URLs   |

**Benefits**:

- Debug API key issues without exposing full key
- Identify tokens by suffix without leaking secrets
- Maximum protection for passwords and sensitive data

#### Lifecycle Metadata (Optional)

Track credential creation, expiry, ownership, and categorization:

| Field     | Type             | Description                                       |
| --------- | ---------------- | ------------------------------------------------- |
| `created` | string (ISO8601) | Creation timestamp                                |
| `expires` | string (ISO8601) | Expiry timestamp for rotation alerts              |
| `purpose` | string           | Purpose slug (e.g., `payment-processing`)         |
| `tags`    | array[string]    | Categorization tags (e.g., `["critical", "pci"]`) |
| `owner`   | string           | Owner/team identifier (e.g., `platform-team`)     |

**Use Cases**:

- Monitor credential expiry and trigger rotation alerts
- Filter credentials by tags for compliance auditing
- Track ownership for security incident response
- Categorize by purpose for access control policies

#### Rotation Policies (Optional)

Document rotation requirements and methods:

| Field      | Type   | Description                                        |
| ---------- | ------ | -------------------------------------------------- |
| `interval` | string | Rotation interval (e.g., `30d`, `90d`, `6m`, `1y`) |
| `method`   | enum   | Rotation method: `auto` or `manual`                |

**Interval Format**: `^[0-9]+[dwmy]$` (days/weeks/months/years)

**Use Cases**:

- Document required rotation frequency (30d for passwords, 90d for API keys)
- Distinguish automated vs manual rotation workflows
- Compliance reporting (e.g., PCI-DSS requires 90-day rotation)

#### External References

**Feature**: `ref` field for secret manager integration

**Supported Patterns**:

- `vault://secrets/staging/db-url` - HashiCorp Vault
- `aws-secrets://prod/api-key` - AWS Secrets Manager
- Custom URI schemes based on tool implementation

**Benefits**:

- Centralize secrets in vault infrastructure
- Share references across multiple projects
- Avoid duplicating sensitive values in files

**Implementation**: Tools implementing this schema should resolve `ref` URIs at runtime

#### Example: Minimal Credential

```yaml
credentials:
  API_KEY:
    type: api_key
    value: sk_live_abc123def456
```

#### Example: Full-Featured Credential

```yaml
credentials:
  STRIPE_API_KEY:
    type: api_key
    value: sk_live_abc123def456
    description: Live Stripe API key for payment processing
    metadata:
      created: "2025-01-15T10:00:00Z"
      expires: "2026-01-15T10:00:00Z"
      purpose: payment-processing
      tags: [payment, critical, pci-scope]
      owner: payments-team
    rotation:
      interval: 90d
      method: auto
```

#### Example: External Reference

```yaml
credentials:
  DATABASE_URL:
    type: password
    ref: vault://secrets/staging/db-url
    description: Database URL from HashiCorp Vault
```

---

## üìê Schema Domain Consistency

**Issue**: Schema `$id` used inconsistent domain

- **Old**: `https://schemas.fulmen.dev/...`
- **New**: `https://schemas.fulmenhq.dev/...` (canonical domain)

**Impact**: Aligns with upcoming schema registry launch this week

**Files Updated**:

- `schemas/devsecops/secrets/v1.0.0/secrets.schema.json` - Updated `$id` field
- All documentation and examples updated to use canonical domain

---

## üìä Statistics

- **Schemas Updated**: 1 (secrets.schema.json)
- **Schemas Validated**: 76 (all pass meta-validation)
- **Examples Updated**: 6 in schema + 6 in defaults.yaml
- **Documentation Pages**: 1 (comprehensive update: 50+ sections)
- **Lines Changed**: ~400+ (schema definitions, examples, docs)
- **Language Wrappers Updated**: 2 (Python, TypeScript)

---

## üîó Downstream Impact

### Unblocks Development

- **fulmen-secrets v0.1.1+**: Rich credential management features enabled
  - Smart masking by credential type
  - Lifecycle tracking for expiry monitoring
  - Rotation policy enforcement
  - External secret manager integration

- **gofulmen embed refresh**: fulmen-secrets can drop local schema copies and use Crucible SSOT via gofulmen

### Enterprise Features Enabled

- **API key lifecycle tracking**: Monitor creation/expiry timestamps
- **Password rotation policies**: Document required rotation frequency
- **Credential expiry monitoring**: Alert on approaching expiry dates
- **Compliance auditing**: Filter credentials by tags (critical, pci-scope)
- **Ownership tracking**: Identify responsible teams for security incidents
- **Smart masking**: Debug without exposing full secrets

---

## üöÄ Upgrade Guide

### For fulmen-secrets Tool (v0.1.0 ‚Üí v0.1.1+)

**Breaking Change**: Schema structure change from flat strings to credential objects

**Migration**:

fulmen-secrets will detect old format and prompt migration:

```bash
# Old format (v0.1.0)
projects:
  - project_slug: myapp
    secrets:
      API_KEY: value123

# New format (v0.1.1+)
projects:
  - project_slug: myapp
    credentials:
      API_KEY:
        type: api_key
        value: value123
```

**Note**: Tool not yet released, so this is a safe pre-release schema update

### For Schema Consumers

**If Implementing Validators**:

1. Update to recognize `credentials` field (not `secrets`)
2. Implement credential object validation (type, value XOR ref)
3. Support optional metadata and rotation fields
4. Implement smart masking based on credential type
5. Test with both `value` and `ref` credential variants

**Example Validation**:

```go
// Validate credential has exactly one of value or ref
if (cred.Value != "" && cred.Ref != "") {
    return errors.New("credential must have value OR ref, not both")
}
if (cred.Value == "" && cred.Ref == "") {
    return errors.New("credential must have either value or ref")
}
```

---

## üìö Documentation Updates

### Files Updated

1. **Schema** (`schemas/devsecops/secrets/v1.0.0/secrets.schema.json`):
   - Added credential object definitions
   - Added metadata and rotation policy objects
   - Updated project_slug pattern for underscores
   - Fixed example numbering (no duplicates)
   - Updated domain to schemas.fulmenhq.dev

2. **Defaults** (`config/devsecops/secrets/v1.0.0/defaults.yaml`):
   - 6 comprehensive examples with new structure
   - Examples showing minimal, full-featured, and multi-project patterns
   - Metadata and rotation policy samples
   - External reference examples (vault://)
   - Updated best practices section

3. **Documentation** (`docs/standards/devsecops/project-secrets.md`):
   - Complete schema structure documentation
   - Credential types & masking behavior table
   - Metadata and rotation policy specifications
   - Updated all usage patterns (5+ patterns)
   - Fixed legacy `secrets:` examples to use `credentials:`
   - Updated "Schema Evolution" section to reflect actual v1.0.0 capabilities
   - Removed false claims about deferred features

### Schema Evolution Section Update

**Old Claims (Incorrect)**:

- ‚ùå "Simple key-value secrets (string ‚Üí string)"
- ‚ùå "Reference-based secrets deferred to v1.1.0"
- ‚ùå "Expiry/rotation metadata deferred to v1.1.0"

**Actual v1.0.0 Features**:

- ‚úÖ Structured credential objects with types
- ‚úÖ Smart masking, lifecycle metadata, rotation policies
- ‚úÖ External references (`ref` field) already available
- ‚úÖ All enterprise features included in v1.0.0

**Note**: Most enterprise features are already available. Future versions (v1.1.0+) will focus on automation (native vault:// resolution, rotation triggers) rather than data model changes.

---

## üîç Review Process

### fulmen-secrets Team Review

**Feedback Received**:

1. ‚úÖ Schema shape correct (credential objects, oneOf enforcement, metadata)
2. ‚úÖ Domain consistency fixed (schemas.fulmenhq.dev)
3. ‚úÖ Example numbering fixed (no duplicates)
4. ‚úÖ Documentation updated (all legacy `secrets:` examples converted to `credentials:`)
5. ‚úÖ Schema Evolution section corrected (accurate v1.0.0 feature list)

**Review Status**: ‚úÖ Approved for publication

**Reviewers**:

- Primary reviewer: fulsecrets team lead
- Secondary reviewer: Schema compliance check

---

## üìã Breaking Change Impact Analysis

### Pre-Release Safe Change

**Why Safe**:

- fulmen-secrets v0.1.0 not yet released (no external consumers)
- No existing files using old format in production
- Breaking change occurs during pre-release development phase

**Post-Release Plan**:

- fulmen-secrets will drop local schema copies
- Use gofulmen embed of Crucible schemas (SSOT)
- Implement migration tool for future format changes

---

## üéØ Use Cases Enabled

### API Key Lifecycle Tracking

```yaml
STRIPE_API_KEY:
  type: api_key
  value: sk_live_...
  metadata:
    created: "2025-01-15T10:00:00Z"
    expires: "2026-01-15T10:00:00Z"
    tags: [payment, critical]
  rotation:
    interval: 90d
    method: auto
```

**Benefits**:

- Monitor approaching expiry dates
- Alert when rotation due
- Track creation for audit logs
- Filter critical credentials

### Password Rotation Policies

```yaml
DATABASE_PASSWORD:
  type: password
  value: supersecure123
  metadata:
    expires: "2025-12-31T23:59:59Z"
    purpose: primary-database
    owner: platform-team
  rotation:
    interval: 30d
    method: manual
```

**Benefits**:

- Document required rotation frequency (30d for PCI compliance)
- Track responsible team for rotation
- Monitor rotation status

### External Secret Manager Integration

```yaml
DATABASE_URL:
  type: password
  ref: vault://secrets/prod/db-url
  description: Production database URL from Vault
```

**Benefits**:

- Centralize secrets in vault infrastructure
- Share references across multiple projects
- Avoid duplicating sensitive values

### Compliance Auditing

```yaml
PAYMENT_API_KEY:
  type: api_key
  value: pk_live_...
  metadata:
    purpose: payment-processing
    tags: [payment, critical, pci-scope]
    owner: payments-team
```

**Benefits**:

- Filter credentials by compliance scope (pci-scope, sox, hipaa)
- Generate compliance reports by tag
- Track ownership for security audits

---

## üîê Security Considerations

### Smart Masking

**Purpose**: Enable debugging without exposing full secrets

**Implementation Guidelines**:

- `api_key`: Show first 8 chars + "..." + last 3 chars (e.g., `sk_live_...xyz`)
- `token`: Show "..." + last 4 chars (e.g., `...1234`)
- `password`: Full redaction (`***REDACTED***`)

**Use Cases**:

- Log credential prefixes for debugging API key issues
- Identify tokens by suffix without leaking full value
- Maximum protection for passwords and database URLs

### Encryption Enforcement

Schema supports `allow_plain_secrets: false` policy for production:

```yaml
policies:
  allow_plain_secrets: false # Reject plaintext files
```

**Benefits**:

- Enforce encryption before git commit
- "FIPS mode" for compliance environments
- Prevent accidental plaintext secret commits

---

## üõ†Ô∏è Technical Details

### Schema Validation

**oneOf Constraint**: Enforces `value` XOR `ref`

```json
"oneOf": [
  { "required": ["value"], "not": { "required": ["ref"] } },
  { "required": ["ref"], "not": { "required": ["value"] } }
]
```

**Ensures**:

- Credentials have exactly one of value or ref
- Prevents ambiguous credential definitions
- Schema-level enforcement (fails validation if both present)

### Pattern Validation

**Project Slugs**: `^[a-z0-9]([a-z0-9_-]*[a-z0-9])?$`

- Start and end with alphanumeric
- Middle can have hyphens, underscores, alphanumeric
- Examples: `backend-api`, `api_staging`, `my_service-v2`

**Rotation Intervals**: `^[0-9]+[dwmy]$`

- Format: number + unit (d=days, w=weeks, m=months, y=years)
- Examples: `30d`, `90d`, `6m`, `1y`

**Environment Variables**: `^[A-Z_][A-Z0-9_]*$`

- UPPER_SNAKE_CASE only
- Start with letter or underscore
- Examples: `API_KEY`, `DATABASE_URL`, `JWT_SECRET`

---

## üîÆ Future Roadmap (v1.1.0+)

### Potential Features

**Automation**:

- Native vault:// URI resolution in fulsecrets
- Automated rotation triggers (API integration)
- Secret templates with interpolation (`${DATABASE_URL}/api`)

**Integration**:

- Telemetry (decrypt events to L'Orage Central)
- Multi-environment tagging (explicit environment field)
- Credential hierarchy (inherit from parent projects)

**Note**: Most enterprise features already in v1.0.0. Future focus on automation rather than data model changes.

---

## üìñ Related Documentation

- [DevSecOps Project Secrets Standard](../docs/standards/devsecops/project-secrets.md)
- [Schema Normalization Standard](../docs/standards/schema-normalization.md)
- [JSON Schema 2020-12 Specification](https://json-schema.org/draft/2020-12/json-schema-core.html)
- [fulmen-secrets Repository](https://github.com/fulmenhq/fulmen-secrets)

---

## üôè Credits

**Developed by**: Schema Cartographer under supervision of @3leapsdave

**Reviewed by**: fulmen-secrets development team

**Triggered by**: fulmen-secrets v0.1.1 pre-release feature requirements

---

## üîú Next Steps

1. ‚úÖ Crucible v0.2.17 published
2. ‚è≥ gofulmen embed refresh (schema updates)
3. ‚è≥ fulmen-secrets v0.1.1 development continues with schema support
4. ‚è≥ Drop local schema copies from fulmen-secrets (use gofulmen embed)

---

**Full Changelog**: [CHANGELOG.md](../CHANGELOG.md)
**Previous Release**: [v0.2.16](v0.2.16.md)

---

<div align="center">

‚ö° **Quality First. Scale Forever.** ‚ö°

</div>
