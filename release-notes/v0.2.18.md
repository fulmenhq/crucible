# Crucible v0.2.18 - HTTP Server Metrics Taxonomy

**Release Date**: 2025-11-17
**Version**: 0.2.18 (SemVer)
**Focus**: Canonical HTTP server metrics for consistent application observability across languages

---

## üéØ Overview

Version 0.2.18 adds canonical HTTP server metrics to the Crucible telemetry taxonomy, enabling standardized HTTP request instrumentation across gofulmen, tsfulmen, and pyfulmen. This release provides 5 core metrics with comprehensive guidance on route normalization, unit conversion, and cardinality management to prevent metric series explosions in production environments.

**Key Highlights**:

- ‚úÖ 5 canonical HTTP server metrics (requests, duration, request/response size, active requests)
- ‚úÖ Histogram bucket defaults for seconds (5ms-10s) and bytes (1KB-100MB)
- ‚úÖ CRITICAL route normalization guidance (templated routes vs literal paths)
- ‚úÖ Unit conversion requirements (milliseconds ‚Üí seconds for duration)
- ‚úÖ Framework-specific extraction patterns (Express, Fastify, chi, gin, httprouter, FastAPI)
- ‚úÖ Production-ready middleware examples for TypeScript, Go, Python
- ‚úÖ prom-client collision warnings for TypeScript/Node.js
- ‚úÖ Cardinality budget analysis (~92K time series per service)

---

## üìä Added

### HTTP Server Metrics - Canonical Taxonomy for Application Observability

**Motivation**: Standardize HTTP server instrumentation across helper libraries; prevent cardinality explosions from unbounded route labels; align duration units (seconds) and bucket defaults ecosystem-wide for consistent dashboards and queries.

#### Metrics Added (5 Core HTTP Metrics)

| Metric Name                     | Type      | Unit    | Description                                  | Required Labels                        |
| ------------------------------- | --------- | ------- | -------------------------------------------- | -------------------------------------- |
| `http_requests_total`           | Counter   | `count` | Total HTTP requests received                 | `method`, `route`, `status`, `service` |
| `http_request_duration_seconds` | Histogram | `s`     | Request latency in seconds                   | `method`, `route`, `status`, `service` |
| `http_request_size_bytes`       | Histogram | `bytes` | Request body size                            | `method`, `route`, `service`           |
| `http_response_size_bytes`      | Histogram | `bytes` | Response body size                           | `method`, `route`, `status`, `service` |
| `http_active_requests`          | Gauge     | `count` | Number of requests currently being processed | `service`                              |

**Optional Labels**:

- `outcome`: HTTP status group (`2xx`, `4xx`, `5xx`) for simplified dashboards

#### Histogram Bucket Defaults

**Duration Buckets** (`seconds_metrics`):

```
[0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1, 2.5, 5, 10]
```

- **Coverage**: 5ms (fast in-memory) ‚Üí 10s (slow backend calls)
- **Use**: Metrics with `unit: s` (seconds)

**Size Buckets** (`bytes_metrics`):

```
[1024, 10240, 102400, 1048576, 10485760, 104857600]
```

- **Coverage**: 1KB ‚Üí 100MB (1KB, 10KB, 100KB, 1MB, 10MB, 100MB)
- **Use**: Metrics with names ending in `_bytes`

#### Documentation Additions (~450 Lines)

**File**: `docs/standards/library/modules/telemetry-metrics.md`

**Added Sections**:

1. **HTTP Server Metrics Section** (lines 121-470):
   - Complete metrics specification table
   - Label value standards with cardinality warnings
   - Route normalization guidance (CRITICAL)
   - Framework-specific extraction patterns
   - Implementation examples for all languages
   - Cardinality budget analysis

2. **Route Normalization (CRITICAL)**:
   - **Problem**: Literal paths create unbounded cardinality
     ```
     ‚ùå /users/123, /users/456, /users/789 ‚Üí 1000s of time series
     ‚úÖ /users/:id ‚Üí single time series
     ```
   - **Framework Extraction Patterns**:
     - **Express**: `req.route?.path` ‚Üí `/users/:id`
     - **Fastify**: `request.routeOptions?.url` ‚Üí `/users/:id`
     - **Go chi**: `chi.RouteContext(r.Context()).RoutePattern()` ‚Üí `/users/{id}`
     - **Go gin**: `c.FullPath()` ‚Üí `/users/:id`
     - **Go httprouter**: Pattern from route registration
     - **Python FastAPI**: `request.scope["route"]` ‚Üí `/users/{id}`
   - **Canonical normalizeRoute() Helper**: Fallback for frameworks without introspection
     ```typescript
     function normalizeRoute(path: string): string {
       return path
         .replace(
           /\/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi,
           "/:uuid",
         )
         .replace(/\/\d+/g, "/:id")
         .replace(/\/[0-9a-f]{24}/g, "/:objectid");
     }
     ```

3. **Unit Conversion Requirements (CRITICAL)**:
   - **Duration**: Taxonomy uses **seconds**, not milliseconds
   - **Helpers MUST convert** before emitting
   - **TypeScript Example**:
     ```typescript
     const durationMs = Date.now() - start;
     const durationSeconds = durationMs / 1000; // Convert!
     metrics
       .histogram("http_request_duration_seconds")
       .observe(durationSeconds);
     ```
   - **Go Example**:
     ```go
     durationSeconds := time.Since(start).Seconds() // Automatic
     telemetry.Histogram("http_request_duration_seconds").Observe(durationSeconds)
     ```
   - **Python Example**:
     ```python
     duration_seconds = time.time() - start  # Already seconds
     metrics.histogram("http_request_duration_seconds").observe(duration_seconds)
     ```
   - **Size**: Already in bytes (Content-Length headers), no conversion needed

4. **prom-client Collision Warning (TypeScript)**:
   - ‚ö†Ô∏è **CRITICAL**: `prom-client` auto-emits `http_requests_total` and `http_request_duration_seconds`
   - **Collision**: Creates duplicate time series with different labels
   - **Fix**: Disable prom-client defaults before using taxonomy metrics
     ```typescript
     import { register } from "prom-client";
     register.clear(); // Clear all default metrics
     ```

5. **Production Middleware Examples**:
   - **TypeScript (Express)**: Full middleware with duration conversion, size capture
   - **Go (chi)**: Middleware with responseWriter wrapper for status/size capture
   - **Python (FastAPI)**: Async middleware with proper lifecycle tracking

#### Cardinality Budget Analysis

**Typical Service Parameters**:

- Methods: 5 (GET, POST, PUT, DELETE, PATCH)
- Routes: 50 (templated routes)
- Status codes: 20 (200, 201, 400, 401, 403, 404, 500, 503, etc.)
- Services: 1 per deployment

**Time Series Estimates**:

- `http_requests_total`: 5 √ó 50 √ó 20 √ó 1 = **5,000 series**
- `http_request_duration_seconds`: 5 √ó 50 √ó 20 √ó 1 √ó 11 buckets = **55,000 series**
- `http_request_size_bytes`: 5 √ó 50 √ó 1 √ó 6 buckets = **1,500 series**
- `http_response_size_bytes`: 5 √ó 50 √ó 20 √ó 1 √ó 6 buckets = **30,000 series**
- `http_active_requests`: 1 = **1 series**
- **Total**: ~92,000 time series per service

**Mitigation**: Acceptable for modern Prometheus/Grafana. If needed:

1. Reduce route count by grouping similar endpoints
2. Use `outcome` instead of `status` for less critical metrics
3. Sample high-cardinality routes (top N only)

#### Schema Updates

**File**: `config/taxonomy/metrics.yaml`

**Changes**:

1. Added 5 metric names to `metricName` enum (lines 47-51)
2. Updated schema to document seconds/bytes bucket types (lines 78-87)
3. Added `seconds_metrics` bucket defaults (lines 114-125)
4. Added `bytes_metrics` bucket defaults (lines 126-132)
5. Added 5 metric definitions with comprehensive descriptions (lines 297-320):
   - Required labels, optional labels
   - Cardinality warnings ("Use templated routes!")
   - Bucket references
   - Use case guidance

#### Files Updated

**Root SSOT**:

- `config/taxonomy/metrics.yaml`: Schema + metrics + bucket defaults
- `docs/standards/library/modules/telemetry-metrics.md`: ~450 lines added

**Language Wrappers** (synced via `make sync`):

- **TypeScript**: `lang/typescript/config/taxonomy/metrics.yaml`, `lang/typescript/docs/standards/library/modules/telemetry-metrics.md`, `lang/typescript/package.json` ‚Üí 0.2.18
- **Python**: `lang/python/config/taxonomy/metrics.yaml`, `lang/python/docs/standards/library/modules/telemetry-metrics.md`, `lang/python/pyproject.toml` ‚Üí 0.2.18, `lang/python/src/crucible/__init__.py` ‚Üí 0.2.18
- **Go**: `schemas.go` ‚Üí 0.2.18

**Version Files**:

- `VERSION` ‚Üí 0.2.18
- `package.json` ‚Üí 0.2.18

---

## üîç Implementation Highlights

### Route Normalization - Preventing Cardinality Explosions

**Problem**:

```
‚ùå WRONG - Literal paths create unbounded cardinality
http_requests_total{route="/users/123"} 1
http_requests_total{route="/users/456"} 1
http_requests_total{route="/users/789"} 1
‚Üí Result: 1000s of time series = metric explosion
```

**Solution**:

```
‚úÖ CORRECT - Templated routes bound cardinality
http_requests_total{route="/users/:id"} 3
‚Üí Result: Single time series aggregating all user requests
```

**Implementation**: Use framework route introspection where available; fallback to canonical normalizeRoute() helper for static frameworks.

### Unit Conversion - Ensuring Bucket Alignment

**Problem**: Taxonomy uses seconds; most timing APIs return milliseconds

**Solution**: Convert before emitting

```typescript
// TypeScript
const durationSeconds = durationMs / 1000;

// Go (automatic)
durationSeconds := time.Since(start).Seconds()

// Python (already seconds)
duration_seconds = time.time() - start
```

**Impact**: Ensures all languages emit compatible values for shared bucket boundaries

### Framework Coverage

**TypeScript/Node.js**:

- Express: `req.route.path`
- Fastify: `request.routeOptions.url`

**Go**:

- chi: `chi.RouteContext(r.Context()).RoutePattern()`
- gin: `c.FullPath()`
- httprouter: Pattern from registration

**Python**:

- FastAPI: `request.scope["route"]`

---

## üé¨ Downstream Impact

### Unblocked Features

**gofulmen** (pending implementation):

- HTTP server middleware with chi/gin/httprouter support
- Route extraction utilities per router
- Duration auto-conversion (time.Duration ‚Üí seconds)

**tsfulmen** (pending implementation):

- Express/Fastify middleware
- prom-client default clearing utilities
- Millisecond ‚Üí second conversion helpers

**pyfulmen** (pending implementation):

- FastAPI/Flask middleware
- time.time() direct usage (no conversion)

### Cross-Language Consistency

All helper libraries will emit:

- **Same metric names**: `http_requests_total`, `http_request_duration_seconds`, etc.
- **Same label names**: `method`, `route`, `status`, `service`, `outcome`
- **Same units**: Seconds (duration), bytes (size)
- **Same buckets**: [5ms...10s] for duration, [1KB...100MB] for size

**Result**: Portable dashboards and queries across languages

---

## üõ°Ô∏è Quality Gates

All quality gates passed:

- ‚úÖ **Schema Validation**: 76 schemas validated (meta + semantic)
- ‚úÖ **Code Generation**: Exit codes, fulpack, fulencode up-to-date
- ‚úÖ **Sync**: TypeScript, Python wrappers updated
- ‚úÖ **Build**: Go, TypeScript, Python - all passed
- ‚úÖ **Linting**: 0 issues, 100% health (goneat, biome, ruff)
- ‚úÖ **Tests**: Go (0.4s), TypeScript (36 tests), Python (10 tests) - all passed
- ‚úÖ **Type Checking**: TypeScript clean

---

## üìã Migration Guide

### For Helper Library Teams

1. **Consume v0.2.18 taxonomy**:
   - gofulmen: Update crucible dependency
   - tsfulmen: Update @fulmenhq/crucible dependency
   - pyfulmen: Update crucible dependency

2. **Implement HTTP metrics**:
   - Read `docs/standards/library/modules/telemetry-metrics.md` HTTP Server Metrics section
   - Use framework-specific route extraction patterns
   - Implement unit conversion (ms ‚Üí seconds for duration)
   - Follow production middleware examples

3. **Test cardinality**:
   - Verify route labels use templates (`:id` not literal IDs)
   - Check bucket alignment (should match taxonomy defaults)
   - Validate unit conversion (duration in seconds, sizes in bytes)

4. **Disable prom-client defaults** (TypeScript only):
   - Clear registry or disable default collection
   - Prevents collision with taxonomy `http_*` metrics

### For Application Teams

**No action required** until helper libraries implement HTTP metrics.

Once available:

1. Add HTTP middleware from helper library
2. Configure service label
3. Deploy and verify metrics in Prometheus
4. Build dashboards using canonical metric names

---

## üéØ Related

- **Feature Brief**: `.plans/active/v0.2.18/http-server-metrics-feature-brief.md`
- **Implementation Review**: `.plans/active/v0.2.18/implementation-review-note.md`
- **ADR-0007**: Telemetry Default Histogram Buckets
- **Telemetry Standard**: `docs/standards/library/modules/telemetry-metrics.md`
- **Metrics Taxonomy**: `config/taxonomy/metrics.yaml`

---

**Generated by Schema Cartographer (@schema-cartographer) under supervision of @3leapsdave**
