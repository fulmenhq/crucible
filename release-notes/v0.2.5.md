# Release Notes: v0.2.5

**Date**: 2025-11-05

Feature release adding standardized signal handling module for cross-language consistency in graceful shutdown, Ctrl+C handling, config reload, and signal-based orchestration across the Fulmen ecosystem. This release establishes the SSOT for signal semantics, OS mappings, and behavior definitions, with comprehensive Windows fallback strategy and helper library implementation guidance.

## Highlights

- **Signal Handling Module**: 8 standard signals with OS mappings and behavior definitions
- **Ctrl+C Double-Tap Pattern**: Graceful first tap, force quit on second (2s window)
- **Windows Fallback Strategy**: Comprehensive support with standardized logging/telemetry
- **HTTP Signal Endpoint**: Minimum spec for `/admin/signal` operational endpoint
- **Exit Code Corrections**: Fixed SIGUSR1/SIGUSR2 exit codes to match POSIX 128+N pattern
- **Helper Library Guidance**: Detailed API requirements with feedback from gofulmen, pyfulmen, tsfulmen teams

## What's New

### 1. Signal Handling Module

Standardized signal handling SSOT enabling consistent graceful shutdown, Ctrl+C handling, config reload, and signal-based orchestration patterns across Fulmen tools.

**Catalog**: `config/library/foundry/signals.yaml`

**Schema**: `schemas/library/foundry/v1.0.0/signals.schema.json`

**Documentation**: `docs/standards/library/modules/signal-handling.md`

**8 Standard Signals**:

| Signal  | Number (Linux) | Purpose                 | Default Behavior                  | Exit Code |
| ------- | -------------- | ----------------------- | --------------------------------- | --------- |
| SIGTERM | 15             | Graceful termination    | graceful_shutdown                 | 143       |
| SIGINT  | 2              | User interrupt (Ctrl+C) | graceful_shutdown_with_double_tap | 130       |
| SIGHUP  | 1              | Config reload           | reload_via_restart                | 129       |
| SIGQUIT | 3              | Quit with core dump     | immediate_exit                    | 131       |
| SIGPIPE | 13             | Broken pipe             | observe_only                      | 141       |
| SIGALRM | 14             | Alarm timer             | immediate_exit                    | 142       |
| SIGUSR1 | 10 (30 macOS)  | User-defined signal 1   | custom                            | 138       |
| SIGUSR2 | 12 (31 macOS)  | User-defined signal 2   | custom                            | 140       |

**6 Behavior Definitions**:

1. **graceful_shutdown**: Clean shutdown with timeout, cleanup chain, resource finalization
2. **graceful_shutdown_with_double_tap**: Graceful first, force quit on second (Ctrl+C pattern)
3. **reload_via_restart**: Validate config, graceful shutdown, restart with new config
4. **immediate_exit**: Exit immediately without cleanup (emergency shutdown)
5. **custom**: Application-specific handler registration
6. **observe_only**: Log and increment telemetry without exiting

**OS Mappings**:

- **Unix**: Native signal handling on Linux, macOS, FreeBSD
- **Windows**: Console event mappings (SIGTERMâ†’CTRL_CLOSE_EVENT, SIGINTâ†’CTRL_C_EVENT, SIGQUITâ†’CTRL_BREAK_EVENT)
- **Platform Overrides**: SIGUSR1/USR2 use different signal numbers on macOS (30/31) vs Linux (10/12)

**Key Features**:

- Exit code integration (128+N POSIX pattern)
- Timeout configuration for graceful shutdown (default: 30s for TERM, 5s for INT)
- Cleanup action ordering (close_connections â†’ flush_buffers â†’ remove_pid_file â†’ log_shutdown)
- Validation-required config reload (SIGHUP must validate schema before restart)
- HTTP signal endpoint for containerized environments
- Platform support matrix with fallback guidance

---

### 2. Ctrl+C Double-Tap Pattern

User-friendly Ctrl+C handling providing both graceful and forceful shutdown options.

**Behavior**:

- **First Ctrl+C**: Initiates graceful shutdown, displays hint message
- **Second Ctrl+C (within 2s)**: Forces immediate exit
- **Second Ctrl+C (after 2s)**: Treats as new graceful shutdown attempt

**Configuration** (from signals.yaml):

```yaml
double_tap_window_seconds: 2
double_tap_message: "Press Ctrl+C again within 2s to force quit"
double_tap_behavior: immediate_exit
double_tap_exit_code: 130
```

**User Experience**:

```bash
$ myapp run
^C  # First Ctrl+C
Press Ctrl+C again within 2s to force quit
Shutting down gracefully...
Closing connections... âœ“
Flushing buffers... âœ“
# App exits cleanly

$ myapp run
^C  # First Ctrl+C
Press Ctrl+C again within 2s to force quit
Shutting down gracefully...
^C  # Second Ctrl+C within window
Force quit!
# App exits immediately (130)
```

---

### 3. Windows Fallback Strategy

Comprehensive Windows support with standardized logging, telemetry, and operational guidance.

**Unsupported Signals on Windows**: SIGHUP, SIGPIPE, SIGALRM, SIGUSR1, SIGUSR2

**Fallback Behavior Types**:

1. **http_admin_endpoint**: Use HTTP POST /admin/signal (SIGHUP, SIGUSR1, SIGUSR2)
2. **exception_handling**: Handle via language-native exceptions (SIGPIPE)
3. **timer_api**: Use language-native timer APIs (SIGALRM)

**Standardized Logging Contract**:

- **Log Level**: INFO (not WARN - expected behavior on Windows)
- **Format**: Structured JSON with consistent fields
- **Template**: `signal=${signal} platform=${platform} fallback=${fallback_behavior} message='${operation_hint}'`

**Example Log Output**:

```
INFO: Signal unavailable on Windows
  signal=SIGHUP
  platform=windows
  fallback=http_admin_endpoint
  operation_hint='POST /admin/signal with signal=HUP'
```

**Standardized Telemetry Contract**:

- **Event Name**: `fulmen.signal.unsupported` (fixed constant across all languages)
- **Required Tags**:
  - `signal`: Signal name (e.g., "SIGHUP")
  - `platform`: Operating system (e.g., "windows")
  - `fallback_behavior`: Fallback type (e.g., "http_admin_endpoint")

**Catalog Metadata** (per signal):

```yaml
windows_fallback:
  fallback_behavior: http_admin_endpoint
  log_level: INFO
  log_message: "SIGHUP unavailable on Windows - use HTTP endpoint for config reload"
  log_template: "signal=${signal} platform=${platform} fallback=${fallback_behavior} message='${operation_hint}'"
  operation_hint: "POST /admin/signal with signal=HUP"
  telemetry_event: fulmen.signal.unsupported
  telemetry_tags:
    signal: SIGHUP
    platform: windows
    fallback_behavior: http_admin_endpoint
```

---

### 4. HTTP Signal Endpoint Minimum Spec

Interim specification for `/admin/signal` endpoint enabling signal delivery in containerized environments (full Admin Surface Standard deferred to future release).

**Endpoint**: `POST /admin/signal`

**Request Contract**:

```json
{
  "signal": "HUP",
  "reason": "config reload requested",
  "correlation_id": "req-123"
}
```

**Response Contracts**:

- **202 Accepted**: `{"status": "accepted", "signal": "HUP", "correlation_id": "req-123", "message": "Signal will be processed asynchronously"}`
- **400 Bad Request**: `{"status": "error", "error": "invalid_signal", "message": "Signal must be one of: TERM, INT, HUP, QUIT, USR1, USR2"}`
- **401 Unauthorized / 403 Forbidden**: Authentication failure
- **429 Too Many Requests**: Rate limit exceeded (with `Retry-After` header)

**Authentication** (Required):

- **Preferred**: mTLS client certificates
- **Alternative**: Bearer token (API key) or Basic auth (internal networks only)
- **Configurable**: Via `admin.signal_endpoint_auth_method` config
- **Default**: mTLS if available, otherwise require Bearer token

**Rate Limiting**:

- **Default**: 10 requests/minute per client (identified by IP or certificate fingerprint)
- **Configurable**: Via `admin.signal_rate_limit` config
- **Enforcement**: Return 429 with `Retry-After` header

**Logging**: All signal endpoint requests **MUST** be logged with correlation ID, source IP, authenticated identity, and signal name.

**Config Reload Parity**: `POST /admin/signal {"signal": "HUP"}` **MUST** validate config before restart, matching Unix SIGHUP behavior.

---

### 5. Exit Code Corrections

Fixed SIGUSR1/SIGUSR2 exit codes to match POSIX 128+N pattern with correct base signal numbers.

**Corrections**:

- **SIGUSR1**: 148 â†’ 138 (128 + 10, Linux signal number)
- **SIGUSR2**: 144 â†’ 140 (128 + 12, Linux signal number)

**Rationale**: Exit codes follow 128+N pattern where N is the **Linux standard signal number**, not platform-specific numbers. macOS/FreeBSD use signals 30/31 for USR1/USR2 at runtime, but exit codes remain 138/140 for consistency.

**Updated Files**:

- `config/library/foundry/exit-codes.yaml`
- `foundry/exit_codes.go`
- `lang/python/src/pyfulmen/foundry/exit_codes.py`
- `lang/typescript/src/foundry/exitCodes.ts`

**Cross-References**: Exit codes catalog now includes cross-references to signals.yaml for behavioral context.

---

### 6. Windows Testing Strategy

Testing requirements for helper libraries without mandatory Windows CI runners.

**Required Test Coverage** (3 scenarios):

1. **Unsupported Signal Registration**:
   - Verify registration logs at INFO level
   - Assert structured logging with correct fields
   - Verify telemetry emission with required tags
   - Ensure graceful return (no exception)

2. **HTTP Endpoint Functional Test**:
   - Verify `/admin/signal` endpoint processes signals correctly
   - Assert 202 Accepted response with proper contract
   - Verify authentication enforcement
   - Test rate limiting behavior

3. **Platform Detection**:
   - Verify correct behavior based on `platform.system()` / `process.platform` / `runtime.GOOS`
   - Unix: handler registered normally
   - Windows: fallback behavior triggered

**CI/CD Guidance**:

- Windows CI runners **not mandatory** for v0.2.5
- Minimum requirement: Manual verification on Windows per release
- Simulation tests sufficient (stub platform detection in tests)

**Example Test** (Python):

```python
def test_windows_unsupported_signal_registration():
    """Verify registration logs and emits telemetry correctly"""
    if platform.system() != "Windows":
        pytest.skip("Windows-specific test")

    with capture_logs() as logs, capture_telemetry() as telemetry:
        signals.handle(signal.SIGHUP, lambda sig: None)

    assert logs[0]["level"] == "INFO"
    assert logs[0]["signal"] == "SIGHUP"
    assert logs[0]["fallback"] == "http_admin_endpoint"
    assert telemetry[0]["event"] == "fulmen.signal.unsupported"
```

---

### 7. Signal Support Introspection

Helper libraries **MUST** expose `supports_signal(signal_name) -> bool` API for platform detection.

**Purpose**:

- Enable apps to gate optional features based on signal availability
- Show platform-specific guidance in CLI help text
- Make tests deterministic (don't rely on OS signals)

**Usage Example**:

```python
from pyfulmen.signals import supports_signal, handle

if supports_signal("SIGHUP"):
    handle(signal.SIGHUP, reload_config_handler)
    print("Config reload: send SIGHUP to reload")
else:
    # Windows
    print("Config reload: POST /admin/signal with signal=HUP")
```

---

### 8. Required Hook Methods

Helper libraries **MUST** expose these hook methods to support behavior identifiers in the catalog:

| Behavior ID                         | Required Hook Methods                                                              |
| ----------------------------------- | ---------------------------------------------------------------------------------- |
| `graceful_shutdown`                 | `on_shutdown(callback)`, `shutdown(timeout_seconds)`                               |
| `graceful_shutdown_with_double_tap` | `on_shutdown(callback)`, `force_exit(exit_code)`, `set_double_tap_window(seconds)` |
| `reload_via_restart`                | `on_reload(validation_callback)`, `restart_with_validation()`                      |
| `immediate_exit`                    | `exit(exit_code)`                                                                  |
| `custom`                            | `handle(signal_name, custom_handler)`                                              |
| `observe_only`                      | `on_observe(signal_name, callback)`                                                |
| **Cross-cutting**                   | `supports_signal(signal_name) -> bool`, `inject_signal_for_test(signal_name)`      |

**Language-Specific Naming**:

- **Go**: `OnShutdown()`, `ForceExit()`, `SupportsSignal()`, `InjectForTest()`
- **Python**: `on_shutdown()`, `force_exit()`, `supports_signal()`, `inject_for_test()`
- **TypeScript**: `onShutdown()`, `forceExit()`, `supportsSignal()`, `injectForTest()`

---

### 9. Signal Fixtures

Test fixtures for validation and cross-language parity testing.

**Valid Fixtures** (`config/library/foundry/fixtures/signals/valid/`):

- `minimal.yaml`: Minimum required fields only
- `complete.yaml`: All optional fields populated
- `custom-behavior.yaml`: Custom signal handlers with application-specific behavior

**Invalid Fixtures** (`config/library/foundry/fixtures/signals/invalid/`):

- `missing-required.yaml`: Missing required fields (signals array)
- `invalid-behavior.yaml`: Invalid behavior identifier
- `invalid-exit-code.yaml`: Exit code out of range (0-255)
- `malformed.yaml`: Intentionally malformed YAML

**Parity Snapshot**: `config/library/foundry/fixtures/signals/parity-snapshot.json`

- Canonical snapshot for cross-language parity testing
- Helper libraries validate their signal parsing matches snapshot

---

## Impact on Users

### For Helper Library Maintainers

**Implementation Requirements** (v0.1.x):

1. **Load Signal Catalog**: Embed `config/library/foundry/signals.yaml`, parse and cache signal definitions
2. **Platform Detection**: Detect OS at runtime, map signal names to platform-appropriate handlers
3. **Handler Registration API**: Implement simple registration (`handle(signal, handler_func)`) with cleanup chains
4. **Ctrl+C Double-Tap**: First Ctrl+C starts graceful shutdown + prints hint, second (within 2s) forces exit
5. **Config Reload Validation**: SIGHUP triggers validation + restart sequence, reject invalid config
6. **Testing Utilities**: `inject_signal_for_test()` for triggering handlers without OS signals
7. **Windows Fallback**: Log at INFO level, emit telemetry, return gracefully for unsupported signals
8. **Signal Support Introspection**: Expose `supports_signal(signal_name) -> bool`
9. **Required Hook Methods**: Implement all methods from table above

**Helper Library Feedback** (all addressed in v0.2.5):

- âœ… **gofulmen**: Catalog metadata, log/telemetry contract, admin endpoint spec, testing guidance, operational docs
- âœ… **pyfulmen**: Signal introspection, telemetry standardization, HTTP contract, config reload parity, CI coverage
- âœ… **tsfulmen**: Windows fallback, admin surface spec, testing strategy, catalog patterns, operational guidance

### For Application Developers

**Benefits** (when helper libraries implement in v0.1.x):

- Consistent graceful shutdown across all Fulmen tools
- Testable signal handling (no OS signals needed in tests)
- Container-friendly HTTP signal endpoint
- Config reload safety with mandatory validation
- Ctrl+C user experience (graceful vs forceful)
- Windows support with clear operational guidance

**Migration**: Module is additive, no changes required for existing applications until helper libraries implement and applications opt-in.

---

## Breaking Changes

**None** - This release contains zero breaking changes:

- Signal handling module is new (SSOT established, implementations pending)
- Exit code corrections only affect signal-induced exit codes (consistent with POSIX)
- All changes are additive to existing functionality

---

## Validation

**All quality gates passed**:

- âœ… Go tests: All passed
- âœ… TypeScript tests: All passed (snapshots updated for exit code corrections)
- âœ… Python tests: All passed
- âœ… Schema validation: Signal catalog validated, cross-validation with exit codes
- âœ… Lint: All languages passed (Biome, Ruff, golangci-lint, goneat)
- âœ… Format: All files formatted (goneat, Biome)
- âœ… Typecheck: TypeScript passed
- âœ… Sync: All assets synced to language wrappers
- âœ… Signal fixtures: Valid fixtures parse correctly, invalid fixtures rejected
- âœ… Exit code generation: Parity verified across all languages

---

## Migration

### Update Dependency

**Go**:

```bash
go get github.com/fulmenhq/crucible@v0.2.5
go mod tidy
```

**TypeScript/Bun**:

```bash
bun add @fulmenhq/crucible@latest
```

**Python**:

```bash
uv add crucible@latest
```

### Exit Code Corrections (Automatic)

**No changes required** - Exit code corrections are internal to Crucible. When you update helper library dependencies, corrected exit codes (SIGUSR1=138, SIGUSR2=140) will sync automatically via `make sync`.

### Signal Handling Module (Pending Helper Library Implementation)

**Status**: SSOT established in Crucible v0.2.5, implementations pending in helper libraries v0.1.x.

**When helper libraries implement**:

1. Update to helper library version with signal handling support (gofulmen, pyfulmen, tsfulmen v0.1.x)
2. Use signal handling APIs in application code:

```python
# Python
from pyfulmen.signals import handle, on_shutdown
import signal

# Register graceful shutdown handler
on_shutdown(cleanup_function)

# Register custom signal handler
handle(signal.SIGUSR1, lambda sig: print("USR1 received"))

# Ctrl+C automatically handled with double-tap pattern
# HTTP /admin/signal endpoint automatically available (if server enabled)
```

**Migration is opt-in** - Existing applications continue to work without signal handling module.

---

## Files Added

**Catalog**:

- `config/library/foundry/signals.yaml` - 8 signals, 6 behaviors, OS mappings

**Schema**:

- `schemas/library/foundry/v1.0.0/signals.schema.json` - JSON Schema validation

**Fixtures**:

- `config/library/foundry/fixtures/signals/valid/` (3 fixtures: minimal, complete, custom-behavior)
- `config/library/foundry/fixtures/signals/invalid/` (4 fixtures: missing-required, invalid-behavior, invalid-exit-code, malformed)
- `config/library/foundry/fixtures/signals/parity-snapshot.json`

**Documentation**:

- `docs/standards/library/modules/signal-handling.md` - Comprehensive module specification
- `.plans/memos/fulmenhq/20251104-signal-handling-introduction.md` - Windows limitations memo

---

## Files Changed

**Version Files**:

- `VERSION` (v0.2.4 â†’ v0.2.5)
- `package.json` (root, TypeScript, Python)
- `lang/python/pyproject.toml`
- `lang/typescript/package.json`

**Exit Codes**:

- `config/library/foundry/exit-codes.yaml` - Corrected SIGUSR1/USR2, added signal cross-references
- `foundry/exit_codes.go` - Regenerated with corrections
- `lang/python/src/pyfulmen/foundry/exit_codes.py` - Regenerated with corrections
- `lang/typescript/src/foundry/exitCodes.ts` - Regenerated with corrections

**Validation**:

- `scripts/validate-schemas.ts` - Added `validateSignalCatalog()` with exit code cross-validation

**Configuration**:

- `.goneatignore` - Added `config/library/foundry/fixtures/signals/invalid/`

**Snapshots**:

- `lang/typescript/test/__snapshots__/exit-codes.test.ts.snap` - Updated for exit code corrections

---

## Implementation Status

**v0.2.5 (This Release)**:

- âœ… Signal catalog with 8 signals and 6 behaviors (SSOT established)
- âœ… JSON Schema validation for signal configurations
- âœ… Comprehensive module standard with Windows strategy
- âœ… HTTP `/admin/signal` minimum spec (interim)
- âœ… Exit code corrections (SIGUSR1/USR2)
- âœ… Signal fixtures for testing and validation
- âœ… Windows fallback strategy documentation
- âœ… Helper library API requirements (with feedback integration)
- âœ… Sync configuration for signal assets to language wrappers
- âœ… CI validation for signal catalog

**v0.1.x Helper Libraries (Immediate Next)**:

- ðŸ”œ **gofulmen**: Signal handling module implementation
- ðŸ”œ **pyfulmen**: Signal handling module implementation
- ðŸ”œ **tsfulmen**: Signal handling module implementation
  - All libraries signal assent and readiness to implement
  - Implementations target v0.1.x patch releases

**v0.3.x+ Workhorses (Future)**:

- ðŸ”œ **groningen** (TypeScript workhorse): Adopt signal handling for graceful shutdown
- ðŸ”œ **percheron** (Python workhorse): Adopt signal handling for graceful shutdown
- ðŸ”œ Template integration: CDRL workflow hooks for signal handling

---

## Related

- [CHANGELOG](../CHANGELOG.md) - Full version history
- [Signal Handling Module Spec](../docs/standards/library/modules/signal-handling.md)
- [Windows Limitations Memo](../.plans/memos/fulmenhq/20251104-signal-handling-introduction.md)
- [Exit Codes Catalog](../config/library/foundry/exit-codes.yaml)
- [Signals Catalog](../config/library/foundry/signals.yaml)
- [Helper Library Standard](../docs/architecture/fulmen-helper-library-standard.md)

---

## Credits

**Implementation**: Schema Cartographer (AI agent, supervised by @3leapsdave)
**Feedback**: gofulmen, pyfulmen, tsfulmen maintainer teams
**Review**: @3leapsdave

---

For questions or issues, see the [CHANGELOG](../CHANGELOG.md) or open an issue on GitHub.
