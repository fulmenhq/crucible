# Release Notes: v0.2.7

**Date**: 2025-11-06

Major feature release establishing comprehensive metrics taxonomy for Prometheus exporters and Fulmen module instrumentation. This release adds 26 total metrics (7 Prometheus exporter + 19 module metrics), implements taxonomy version synchronization with repository SemVer, and provides complete telemetry implementation guidance for cross-language consistency.

## Highlights

- **Prometheus Exporter Metrics**: 7 canonical metrics for exporter infrastructure observability
- **Module Telemetry Metrics**: 19 metrics across Foundry, Error Handling, and FulHash modules
- **Metric Namespace Governance**: Framework for module vs application metric separation
- **Taxonomy Version Sync**: Automated synchronization with repository VERSION
- **Test Fixtures**: Comprehensive fixtures for validation and parity testing
- **Telemetry Documentation**: Complete SSOT for helper library implementation

## What's New

### 1. Prometheus Exporter Metrics Taxonomy

Standardized metrics for Prometheus exporter internal observability, enabling portable dashboards and alerts across all helper libraries (gofulmen, pyfulmen, tsfulmen).

**7 Canonical Metrics**:

| Name                                           | Unit    | Type      | Description                                                     | Required Labels   |
| ---------------------------------------------- | ------- | --------- | --------------------------------------------------------------- | ----------------- |
| `prometheus_exporter_refresh_duration_seconds` | `s`     | Histogram | Time to refresh/export registry data into Prometheus collectors | `phase`, `result` |
| `prometheus_exporter_refresh_total`            | `count` | Counter   | Total refresh cycles attempted (success/error breakdown)        | `result`          |
| `prometheus_exporter_refresh_errors_total`     | `count` | Counter   | Failed refresh cycles with detailed error classification        | `error_type`      |
| `prometheus_exporter_refresh_inflight`         | `count` | Gauge     | Number of concurrent refresh operations currently running       | None              |
| `prometheus_exporter_http_requests_total`      | `count` | Counter   | HTTP scrape/exposition requests handled by exporter             | `status`, `path`  |
| `prometheus_exporter_http_errors_total`        | `count` | Counter   | HTTP exposition failures (5xx, auth failures, timeouts)         | `status`, `path`  |
| `prometheus_exporter_restarts_total`           | `count` | Counter   | Exporter refresh loop or HTTP server restarts                   | `reason`          |

**Key Features**:

- **Standardized Label Values**: Enumerated values for phase (`collect|convert|export`), result (`success|error`), error_type (`validation|io|timeout|other`), reason (`config_change|error|manual|other`)
- **Dual Counter Pattern**: Both `refresh_total` and `refresh_errors_total` with mathematical invariant: `sum(refresh_errors_total) = sum(refresh_total{result="error"})`
- **Histogram Buckets**: ADR-0007 millisecond buckets converted to seconds: `[0.001, 0.005, 0.01, 0.05, 0.1, 0.5, 1.0, 5.0, 10.0]`
- **Prometheus Client Defaults Guidance**: Code examples for disabling default metrics (TypeScript, Python, Go) to prevent duplicate time series
- **Cardinality Warning**: `client` label marked optional with high cardinality risk documentation

**Purpose**: Enable consistent exporter monitoring dashboards, alert rules, and operational insights across the Fulmen ecosystem regardless of implementation language.

---

### 2. Module Telemetry Metrics

19 metrics providing module-level observability for core Fulmen modules, enabling performance monitoring, usage analytics, and operational insights.

#### Foundry Module (12 metrics)

**MIME Type Detection Observability**:

**Counters** (6 metrics):

- `foundry_mime_detections_total_json`
- `foundry_mime_detections_total_xml`
- `foundry_mime_detections_total_yaml`
- `foundry_mime_detections_total_csv`
- `foundry_mime_detections_total_plain_text`
- `foundry_mime_detections_total_unknown`

**Histograms** (6 metrics):

- `foundry_mime_detection_ms_json`
- `foundry_mime_detection_ms_xml`
- `foundry_mime_detection_ms_yaml`
- `foundry_mime_detection_ms_csv`
- `foundry_mime_detection_ms_plain_text`
- `foundry_mime_detection_ms_unknown`

**Design Rationale**:

- **Per-Type Metrics**: Separate metrics for each MIME type enable algorithm-specific performance analysis
- **Dual Instrumentation**: Both count (usage patterns) and latency (performance) for each type
- **Label-Free Design**: MIME type encoded in metric name to avoid high cardinality from dynamic content types
- **Histogram Buckets**: ADR-0007 millisecond buckets: `[1, 5, 10, 50, 100, 500, 1000, 5000, 10000]` ms

#### Error Handling Module (2 metrics)

**Error Wrap Operation Monitoring**:

- `error_handling_wraps_total` (counter): Total error wrap operations performed
- `error_handling_wrap_ms` (histogram): Error wrap operation latency in milliseconds

**Design Rationale**:

- **Minimal Overhead**: Error wrapping should be fast; histogram enables performance regression detection
- **Usage Tracking**: Counter reveals error handling patterns and frequency
- **No Error Type Labels**: Error classification lives in wrapped error metadata, not metric labels

#### FulHash Module (5 metrics)

**Hash Algorithm Usage and Performance**:

**Counters** (4 metrics):

- `fulhash_operations_total_xxh3_128`: Total XXH3-128 hash operations (performance-oriented)
- `fulhash_operations_total_sha256`: Total SHA256 hash operations (security-oriented)
- `fulhash_hash_string_total`: Total string hash operations (any algorithm)
- `fulhash_bytes_hashed_total`: Total bytes processed (counter value = byte count)

**Histogram** (1 metric):

- `fulhash_operation_ms`: Hash operation latency for all algorithms

**Design Rationale**:

- **Algorithm Distribution**: Separate counters reveal security vs performance trade-offs
- **Byte Throughput**: Enables capacity planning and performance benchmarking
- **Operation Types**: Separate counter for string hashing (common use case)
- **Unified Latency**: Single histogram for all hash operations (algorithm differentiation via rate queries)

**Implementation Status**:

- âœ… PyFulmen v0.1.12: All 19 metrics implemented and validated
- ðŸ”œ gofulmen: Awaiting taxonomy merge for implementation
- ðŸ”œ tsfulmen: Awaiting taxonomy merge for implementation

---

### 3. Metric Namespace Governance Framework

Comprehensive rules for metric naming, module prefixes, and application metric separation to prevent namespace collisions and ensure consistent observability.

**Reserved Module Prefixes** (Crucible-managed):

- `foundry_*` - Foundry module metrics
- `error_handling_*` - Error handling module metrics
- `fulhash_*` - FulHash module metrics
- `prometheus_exporter_*` - Prometheus exporter infrastructure metrics
- `pathfinder_*`, `config_*`, `schema_*`, `logging_*`, etc. - Other module namespaces

**Application Metric Rules**:

- **Naming Convention**: Binary-prefixed names (e.g., `percheron_*`, `groningen_*`, `sumpter_*`)
- **Taxonomy Exclusion**: Application metrics NOT added to taxonomy (emitted directly via Prometheus clients)
- **Namespace Separation**: Applications must NOT use reserved module prefixes
- **Example**: Percheron workhorse uses `percheron_task_duration_ms`, not `foundry_*` or `prometheus_*`

**Three-Tier Architecture**:

1. **Module Internals** (in taxonomy): Module-specific metrics for cross-language consistency
2. **Infrastructure** (in taxonomy): Shared infrastructure metrics like `prometheus_exporter_*`
3. **Application** (not in taxonomy): Binary-specific metrics emitted directly by applications

**Petition Process**:

- Module metrics that benefit ecosystem-wide observability: Submit PR to `config/taxonomy/metrics.yaml`
- Application-specific metrics: Emit directly, do not extend taxonomy
- Implementation extensions: Libraries MAY add metrics beyond taxonomy (with adaptation caveat)

---

### 4. Taxonomy Version Sync Automation

Automated synchronization ensures taxonomy version never drifts from repository VERSION.

**Implementation**:

1. **Proactive Sync**: `make version-set` and `make version-propagate` now update taxonomy
2. **Build-time Safety**: `make sync` includes taxonomy (redundant safety)
3. **CI Validation**: `make validate-schemas` fails if taxonomy version â‰  repository VERSION

**Scripts**:

- `scripts/update-version.ts` - Propagates VERSION to `config/taxonomy/metrics.yaml`
- `scripts/validate-taxonomy-version.ts` - Validates consistency (new)
- Integrated into Makefile version management targets

**Version Migration**: Taxonomy switched from CalVer (`2025.10.3`) â†’ SemVer (`0.2.7`) per ADR-0010

**Schema Pattern Update**:

- Old: `"^\\d{4}\\.\\d{2}\\.\\d+$"` (CalVer)
- New: `"^\\d+\\.\\d+\\.\\d+$"` (SemVer)

---

### 5. Metrics Test Fixtures

Comprehensive test fixtures for validation and cross-language parity testing.

**Directory Structure**:

```
tests/
â”œâ”€â”€ fixtures/
â”‚   â””â”€â”€ metrics/
â”‚       â”œâ”€â”€ prometheus/          # 7 valid + 1 invalid fixture
â”‚       â”‚   â”œâ”€â”€ histogram-duration-valid.json
â”‚       â”‚   â”œâ”€â”€ counter-refresh-total-valid.json
â”‚       â”‚   â”œâ”€â”€ counter-errors-valid.json
â”‚       â”‚   â”œâ”€â”€ gauge-inflight-valid.json
â”‚       â”‚   â”œâ”€â”€ counter-http-requests-valid.json
â”‚       â”‚   â”œâ”€â”€ counter-http-errors-valid.json
â”‚       â”‚   â”œâ”€â”€ counter-restarts-valid.json
â”‚       â”‚   â””â”€â”€ invalid-unknown-label.json
â”‚       â””â”€â”€ general/             # 2 general fixtures
â”‚           â”œâ”€â”€ counter-simple.json
â”‚           â””â”€â”€ histogram-ms.json
â””â”€â”€ README.md  # Complete usage guide with parity testing examples
```

**Fixture Purpose**:

- Validate helper library metric emission against schema
- Test cross-language parity (same metric, same structure)
- Provide reference examples for implementers
- Enable snapshot testing for regression detection

**Usage Example** (from README):

**Python**:

```python
def test_prometheus_histogram_parity():
    fixture = load_fixture("prometheus/histogram-duration-valid.json")
    metric = metrics.histogram("prometheus_exporter_refresh_duration_seconds", 0.042)
    assert metric.to_dict() == fixture  # Schema parity
```

**TypeScript**:

```typescript
test("Prometheus histogram parity", () => {
  const fixture = loadFixture("prometheus/histogram-duration-valid.json");
  const metric = metrics.histogram(
    "prometheus_exporter_refresh_duration_seconds",
    0.042,
  );
  expect(metric).toEqual(fixture); // Schema parity
});
```

---

### 6. Seconds Unit Support

Added `s` (seconds) to `metricUnit` enum for Prometheus-native histogram conventions.

**Rationale**:

- Prometheus naming convention uses `_seconds` suffix (not `_ms`)
- Minimal schema change (one enum value)
- Reuses ADR-0007 bucket boundaries with conversion

**Bucket Conversion**:

- **ADR-0007 milliseconds**: `[1, 5, 10, 50, 100, 500, 1000, 5000, 10000]` ms
- **Converted to seconds**: `[0.001, 0.005, 0.01, 0.05, 0.1, 0.5, 1.0, 5.0, 10.0]` s
- **Implementation Rule**: Divide millisecond buckets by 1000 before emitting to Prometheus

**Warning**: Do not double-convert; exporters should convert once at emission time.

---

### 7. Telemetry Metrics Documentation Enhancement

Complete SSOT documentation for telemetry implementation in `docs/standards/library/modules/telemetry-metrics.md`.

**New Sections**:

1. **Prometheus Exporter Metrics**:
   - Complete metrics specification table
   - Label value enumerations with allowed values
   - Histogram bucket conversion (ADR-0007 ms â†’ seconds)
   - Dual counter emission rules with PromQL examples
   - Mathematical invariant: `sum(refresh_errors_total) = sum(refresh_total{result="error"})`

2. **Prometheus Client Defaults Guidance**:
   - **TypeScript/Node.js**: `register.clear()` or `collectDefaultMetrics({ register: null })`
   - **Python**: `REGISTRY.unregister(PROCESS_COLLECTOR)`, etc.
   - **Go**: Use custom registry instead of default

3. **Metric Namespace Governance**:
   - Reserved prefixes for Fulmen modules
   - Application metric naming conventions
   - Three-tier architecture explanation
   - Collision prevention guidelines

4. **Module Metrics Specification**:
   - Complete tables for Foundry, Error Handling, FulHash metrics
   - Design rationales for per-type metrics
   - Implementation guidance for helper libraries
   - Cross-language consistency requirements

5. **Compatibility Matrix**:
   - gofulmen â‰¥v0.x.y (to be determined)
   - pyfulmen â‰¥v0.1.12 (implemented)
   - tsfulmen â‰¥v0.x.y (to be determined)

**Documentation as SSOT**: Feature brief explicitly calls out `telemetry-metrics.md` as canonical reference for implementation.

---

## Impact on Users

### For Helper Library Maintainers

**Immediate Actions**:

1. **Update Crucible dependency to v0.2.7**:

   ```bash
   go get github.com/fulmenhq/crucible@v0.2.7
   ```

2. **Implement Prometheus Exporter Metrics** (7 metrics):
   - Use taxonomy metric names (not local enums)
   - Apply standardized label values
   - Implement dual counter pattern (`refresh_total` + `refresh_errors_total`)
   - Convert histogram buckets: ADR-0007 ms Ã· 1000 â†’ seconds
   - Disable Prometheus client defaults per language-specific guidance

3. **Implement Module Metrics** (19 metrics):
   - Emit automatically during module operations (no explicit instrumentation from consumers)
   - Follow per-type metric design for MIME detection
   - Ensure thread safety for concurrent access
   - Maintain <1ms performance overhead per operation

4. **Reference SSOT Documentation**:
   - `docs/standards/library/modules/telemetry-metrics.md` is canonical implementation guide
   - Follow metric naming conventions and label standards
   - Petition Crucible for new metrics that benefit ecosystem-wide observability

### For Application Developers

**No Changes Required**: This is a Crucible SSOT update. Changes are transparent when helper libraries adopt v0.2.7.

**Future Benefits** (when helper libraries implement):

- Consistent telemetry across all Fulmen tools for fleet-wide dashboards
- Portable alert rules using standardized metric names and labels
- Module-level observability (MIME detection, error handling, hashing performance)
- Prometheus exporter health monitoring

---

## Breaking Changes

**None** - This release contains zero breaking changes:

- All metrics are new additions to taxonomy
- Taxonomy version migration (CalVer â†’ SemVer) is internal consistency improvement
- Existing code continues to work without modification
- Module metrics emit automatically (no API changes for consumers)

---

## Validation

**All quality gates passed**:

- âœ… Schema validation: Taxonomy + all schemas valid
- âœ… Version consistency: Taxonomy 0.2.7 = repository VERSION
- âœ… Exit code generation parity: Go, Python, TypeScript all verified
- âœ… SSOT sync: Documentation and config synced to Python + TypeScript wrappers
- âœ… Format: All files formatted (goneat + Biome)
- âœ… Lint: TypeScript, Python, Go, YAML all passed
- âœ… Tests: Go (1), TypeScript (16), Python (10) - all passing
- âœ… Type check: TypeScript passed
- âœ… Test fixtures: All valid fixtures conform to schema, invalid fixture correctly rejected

---

## Migration

### Update Dependency

**Go**:

```bash
go get github.com/fulmenhq/crucible@v0.2.7
go mod tidy
```

**TypeScript/Bun**:

```bash
bun add @fulmenhq/crucible@latest
```

**Python**:

```bash
uv add crucible@latest
```

### No Code Changes Required

This feature release adds metrics to taxonomy and establishes governance framework. No migration steps needed for existing applications.

**Helper Library Implementation** (next):

- gofulmen: Implement 26 taxonomy metrics in v0.1.x
- pyfulmen: Already implemented 19 module metrics in v0.1.12; add 7 Prometheus exporter metrics in v0.1.13
- tsfulmen: Implement 26 taxonomy metrics in v0.1.x

---

## Files Added

**Test Fixtures**:

- `tests/README.md` - Fixture documentation with parity testing examples
- `tests/fixtures/metrics/prometheus/` - 8 Prometheus metric fixtures (7 valid + 1 invalid)
- `tests/fixtures/metrics/general/` - 2 general metric fixtures

**Scripts**:

- `scripts/validate-taxonomy-version.ts` - Version consistency validation

---

## Files Changed

**Version Files**:

- `VERSION` (0.2.6 â†’ 0.2.7)
- `package.json` (root, TypeScript, Python)
- `lang/python/pyproject.toml`
- `lang/typescript/package.json`

**Taxonomy**:

- `config/taxonomy/metrics.yaml` - Added 26 metrics (7 Prometheus + 19 module), switched to SemVer
- `lang/python/config/taxonomy/metrics.yaml` - Synced
- `lang/typescript/config/taxonomy/metrics.yaml` - Synced

**Documentation**:

- `docs/standards/library/modules/telemetry-metrics.md` - Added Prometheus + module metrics sections, governance framework
- `lang/python/docs/standards/library/modules/telemetry-metrics.md` - Synced
- `lang/typescript/docs/standards/library/modules/telemetry-metrics.md` - Synced

**Scripts**:

- `scripts/update-version.ts` - Added taxonomy version propagation
- `scripts/validate-taxonomy-version.ts` - New validation script
- `Makefile` - Integrated taxonomy validation

**Other**:

- `schemas.go` - Embed version update

---

## Implementation Status

**v0.2.7 (This Release)**:

- âœ… 7 Prometheus exporter metrics in taxonomy
- âœ… 19 module metrics in taxonomy (Foundry, Error Handling, FulHash)
- âœ… Metric namespace governance framework documented
- âœ… Taxonomy version sync automation implemented
- âœ… Test fixtures with comprehensive examples
- âœ… Seconds unit support added to taxonomy
- âœ… Complete telemetry documentation as SSOT

**Helper Libraries (Next)**:

- ðŸ”œ gofulmen v0.1.x: Implement all 26 taxonomy metrics
- âœ… pyfulmen v0.1.12: 19 module metrics implemented
- ðŸ”œ pyfulmen v0.1.13: Add 7 Prometheus exporter metrics
- ðŸ”œ tsfulmen v0.1.x: Implement all 26 taxonomy metrics

**Applications (Future)**:

- ðŸ”œ Percheron, Groningen: Adopt module metrics for operational monitoring
- ðŸ”œ Dashboard templates: Standard Grafana dashboards for Fulmen ecosystem
- ðŸ”œ Alert rules: PromQL alert templates for exporter health and module performance

---

## Related

- [CHANGELOG](../CHANGELOG.md) - Full version history
- [Telemetry Metrics Module Spec](../docs/standards/library/modules/telemetry-metrics.md) - Canonical SSOT
- [Metrics Taxonomy](../config/taxonomy/metrics.yaml) - 26 metrics catalog
- [Test Fixtures README](../tests/README.md) - Fixture usage and parity testing
- [ADR-0007](../docs/architecture/decisions/ADR-0007-telemetry-default-histogram-buckets.md) - Histogram bucket rationale
- [ADR-0010](../docs/architecture/decisions/ADR-0010-semantic-versioning-adoption.md) - SemVer adoption rationale

---

## Credits

**Implementation**: Schema Cartographer (AI agent, supervised by @3leapsdave)
**Feedback**: gofulmen, pyfulmen, tsfulmen maintainer teams
**Design**: Cross-team collaboration on metrics taxonomy and governance
**Review**: @3leapsdave

---

For questions or issues, see the [CHANGELOG](../CHANGELOG.md) or open an issue on GitHub.
