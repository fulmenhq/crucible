# Release Notes: v0.2.4

**Date**: 2025-11-04

Feature release adding application identity module for consistent metadata across Fulmen ecosystem, schema export enhancement specification for helper libraries, and critical exit code escaping fixes. This release establishes the foundation for standardized application identity discovery and cross-language asset distribution patterns.

## Highlights

- **App Identity Module**: Schema-driven application identity metadata with zero Fulmen dependencies
- **Schema Export Enhancement**: Specification for helper libraries to safely export Crucible assets to consumer applications
- **Exit Code Escaping Fixes**: Corrected double-escaping bugs in Python and TypeScript codegen templates
- **Schema Upgrades**: Migrated schemas to JSON Schema 2020-12 for improved validation

## What's New

### 1. App Identity Module

Schema-driven application identity metadata enabling consistent discovery patterns across Fulmen ecosystem.

**Schema**: `schemas/config/repository/app-identity/v1.0.0/app-identity.schema.json`

**Documentation**: `docs/standards/library/modules/app-identity.md`

**Configuration**:

- Example: `config/repository/app-identity/app-identity.example.yaml`
- Valid fixtures: minimal, complete, monorepo-api, monorepo-worker
- Invalid fixtures: missing-required, invalid-binary-name, invalid-env-prefix, invalid-vendor, malformed-yaml
- Canonical parity snapshot: `config/repository/app-identity/parity-snapshot.json`

**Key Features**:

- **Discovery Precedence**: explicit â†’ env â†’ ancestor â†’ test injection
- **Dependency Layering**: Layer 0 module (zero Fulmen dependencies)
- **Runtime Caching**: Read-once per process guarantee
- **Cross-Language Support**: Implementation patterns for Go, Python, TypeScript
- **CDRL Integration**: Workflow hooks for template refitting
- **Validation**: CI pipeline validation via `scripts/validate-schemas.ts`

**Application Identity Structure**:

```yaml
vendor: "fulmenhq"
project: "brooklyn-mcp"
binary_name: "brooklyn"
version: "0.1.0"
env_prefix: "BROOKLYN"
packaging:
  python:
    package: "brooklyn_mcp"
    module: "brooklyn_mcp"
```

**Discovery Pattern**:

1. **Explicit Path**: Application provides path to `app.yaml`
2. **Environment Variable**: `{ENV_PREFIX}_APP_IDENTITY_PATH`
3. **Ancestor Search**: Walk up from CWD looking for `.fulmen/app.yaml`
4. **Test Injection**: Mock identity for testing (never search ancestors)

**Usage Examples**:

```go
// Go
import "github.com/fulmenhq/gofulmen/identity"

app, err := identity.Discover()
fmt.Printf("App: %s/%s v%s\n", app.Vendor, app.Project, app.Version)
```

```python
# Python
from pyfulmen.identity import discover_app_identity

app = discover_app_identity()
print(f"App: {app.vendor}/{app.project} v{app.version}")
```

```typescript
// TypeScript
import { discoverAppIdentity } from "@fulmenhq/tsfulmen/identity";

const app = discoverAppIdentity();
console.log(`App: ${app.vendor}/${app.project} v${app.version}`);
```

---

### 2. Schema Export Enhancement

Specification for helper libraries to export Crucible assets (schemas, docs, config) to consumer applications with safe provenance tracking.

**Feature Brief**: `.plans/active/v0.2.4/schema-export-enhancement-feature-brief.md`

**Key Features**:

- **Three Provenance Modes**:
  - `$comment`: Inject provenance directly into schema files (default)
  - `compatible`: Sibling `.meta.json` files for unmodified schemas
  - `sidecar`: Single `.crucible-provenance.json` file for all assets
- **Cross-Language Abstraction**: Go embeds from Crucible root, TypeScript/Python sync to helper libraries
- **CLI Entry Points**: `tsfulmen schema export`, `pyfulmen schema export`, Go package API
- **App Identity Integration**: Auto-inject app identity when `.fulmen/app.yaml` present
- **Safety Guards**: Prevent pollution of Crucible source directories
- **Canonical Snapshots**: JSON snapshots for cross-language parity testing

**Use Cases**:

1. **Template Validation**: Export schemas to validate configuration files
2. **Code Generation**: Generate types/interfaces from schemas
3. **Documentation**: Generate docs from schema definitions
4. **Testing**: Provide fixtures for integration tests

**CLI Usage**:

```bash
# TypeScript
tsfulmen schema export pathfinder/find-query --output schemas/ --mode $comment

# Python
pyfulmen schema export pathfinder/find-query --output schemas/ --mode compatible

# Go (programmatic)
import "github.com/fulmenhq/gofulmen/crucible"
err := crucible.ExportSchema("pathfinder/find-query", "schemas/", crucible.ProvenanceComment)
```

**Safety Guards**:

- Refuse to export to Crucible source directories
- Validate output directory exists
- Error on file conflicts (unless `--force`)
- Warn about provenance mode implications

---

### 3. Exit Code Escaping Fixes

Fixed critical double-escaping bugs in Python and TypeScript codegen templates that caused incorrect rendering of backslash characters.

**Issue**: Exit code 131 context was displaying `Ctrl+\\` instead of `Ctrl+\` at runtime due to double-escaping in codegen templates.

**Python Fix**:

- Changed template to use `pyjson` filter for proper JSON escaping
- Updated YAML source: `exit-codes.yaml` corrected escape sequence
- Regenerated: `lang/python/src/pyfulmen/foundry/exit_codes.py`
- Discovered by: pyfulmen v0.1.9 test_exit_codes_parity test

**TypeScript Fix**:

- Replaced manual `.replace(/\\/g, '\\\\')` with `JSON.stringify()` for correct escaping
- Updated template: `scripts/codegen/exit-codes/typescript/template.ejs`
- Regenerated: `lang/typescript/src/foundry/exitCodes.ts`
- Updated snapshots: `lang/typescript/test/__snapshots__/exit-codes.test.ts.snap`
- Discovered by: tsfulmen snapshot validation test

**Template Changes**:

```javascript
// Before (manual escaping - double-escapes)
description: '<%= item.description.replace(/\\/g, '\\\\') %>'

// After (JSON.stringify - correct escaping)
description: <%- JSON.stringify(item.description) %>
```

**Validation**: Parity tests now pass across all language implementations (Go, Python, TypeScript).

---

### 4. Schema Upgrades to JSON Schema 2020-12

Upgraded schemas to JSON Schema 2020-12 for improved validation and ecosystem compatibility.

**Schemas Updated**:

- App Identity: `schemas/config/repository/app-identity/v1.0.0/app-identity.schema.json`
- Similarity v1.0.0: `schemas/library/foundry/v1.0.0/similarity.schema.json`
- Similarity v2.0.0: `schemas/library/foundry/v2.0.0/similarity.schema.json`

**Validation**: All schemas validated with goneat during CI pipeline.

---

### 5. Code Generation Standard Update

Updated code generation standard to document SSOT sync configuration requirements for distributing generated code to helper libraries.

**Documentation**: `docs/standards/code-generation-template-standard.md`

**Key Addition**: Helper libraries (tsfulmen, pyfulmen) must configure `.crucible/metadata/sync-keys.yaml` to include `src/` directory to receive generated code bindings. Go libraries exempt (embed directly from Crucible).

**Sync Configuration Example**:

```yaml
# .crucible/metadata/sync-keys.yaml
sync_keys:
  - source: src/
    destination: src/
    languages: [typescript, python]
```

---

## Impact on Users

### For Helper Library Maintainers

**App Identity Module**:

- Implement discovery functions using provided patterns
- Read schema and fixtures from synced Crucible assets
- Validate app.yaml files against schema
- Cache identity per process

**Schema Export Feature**:

- Implement CLI commands or package APIs per specification
- Choose provenance mode based on ecosystem conventions
- Integrate with app identity for automatic injection
- Add cross-language parity tests using canonical snapshots

**Exit Code Fixes**:

- Automatic via `make sync` after updating Crucible dependency
- No code changes required

### For Application Developers

**App Identity**:

- Create `.fulmen/app.yaml` in repository root
- Configure vendor, project, binary name, version, env_prefix
- Access identity via helper library discovery functions
- Use for logging, telemetry, error reporting

**Schema Export** (when libraries implement):

- Export schemas for validation, codegen, or documentation
- Choose provenance mode based on project needs
- Benefit from automatic app identity integration

---

## Breaking Changes

**None** - This release contains zero breaking changes:

- App Identity module is new (additive)
- Schema Export is specification only (implementation pending)
- Exit code fixes are internal to codegen (no API changes)
- Schema upgrades preserve backward compatibility

---

## Validation

**All quality gates passed**:

- âœ… Go tests: All passed
- âœ… TypeScript tests: All passed
- âœ… Python tests: All passed
- âœ… Schema validation: All schemas valid (including JSON Schema 2020-12 upgrades)
- âœ… Lint: All languages passed (Biome, Ruff, golangci-lint, goneat)
- âœ… Format: All files formatted (goneat, Biome)
- âœ… Typecheck: TypeScript passed
- âœ… Sync: All assets synced to language wrappers
- âœ… Exit code generation: Parity verified across all languages
- âœ… App Identity validation: Example and fixtures validated

---

## Migration

### Update Dependency

**Go**:

```bash
go get github.com/fulmenhq/crucible@v0.2.4
go mod tidy
```

**TypeScript/Bun**:

```bash
bun add @fulmenhq/crucible@latest
```

**Python**:

```bash
uv add crucible@latest
```

### Exit Code Escaping (Automatic)

**No changes required** - Exit code escaping fixes are internal to Crucible codegen. When you update your helper library dependencies (tsfulmen, pyfulmen), the corrected exit codes will sync automatically via `make sync`.

### App Identity (Optional)

**To adopt App Identity module**:

1. Create `.fulmen/app.yaml` in repository root:

```yaml
vendor: "myorg"
project: "myapp"
binary_name: "myapp"
version: "1.0.0"
env_prefix: "MYAPP"
```

2. Update helper library to version with App Identity support (gofulmen, pyfulmen, tsfulmen v0.2.4+)

3. Use discovery function in application code:

```python
from pyfulmen.identity import discover_app_identity
app = discover_app_identity()
```

**Migration is opt-in** - Existing applications continue to work without App Identity.

---

## Files Added

**Schemas**:

- `schemas/config/repository/app-identity/v1.0.0/app-identity.schema.json`

**Configuration**:

- `config/repository/app-identity/app-identity.example.yaml`
- `config/repository/app-identity/fixtures/valid/` (4 fixtures)
- `config/repository/app-identity/fixtures/invalid/` (5 fixtures)
- `config/repository/app-identity/parity-snapshot.json`

**Documentation**:

- `docs/standards/library/modules/app-identity.md` - Comprehensive module specification
- `.plans/active/v0.2.4/schema-export-enhancement-feature-brief.md` - Feature specification

**Sync Configuration**:

- Updated `config/sync/sync-keys.yaml` with app-identity sync keys

**Validation**:

- Updated `scripts/validate-schemas.ts` with `validateAppIdentityExample()` function

---

## Files Changed

**Version Files**:

- `VERSION` (v0.2.3 â†’ v0.2.4)
- `package.json` (root, TypeScript, Python)

**Exit Code Templates**:

- `scripts/codegen/exit-codes/python/template.jinja` - Added pyjson filter
- `scripts/codegen/exit-codes/typescript/template.ejs` - Changed to JSON.stringify()

**Generated Exit Codes**:

- `foundry/exit_codes.go` - Backslash escaping corrected
- `lang/python/src/pyfulmen/foundry/exit_codes.py` - Backslash escaping corrected
- `lang/typescript/src/foundry/exitCodes.ts` - Backslash escaping corrected

**Exit Code Catalog**:

- `config/library/foundry/exit-codes.yaml` - Corrected escape sequence

**Schemas** (JSON Schema 2020-12 upgrades):

- `schemas/library/foundry/v1.0.0/similarity.schema.json`
- `schemas/library/foundry/v2.0.0/similarity.schema.json`

**Documentation**:

- `docs/standards/code-generation-template-standard.md` - Added SSOT sync configuration section

**Snapshots**:

- `lang/typescript/test/__snapshots__/exit-codes.test.ts.snap` - Updated for corrected escaping

---

## Implementation Status

**v0.2.4 (This Release)**:

- âœ… App Identity schema and documentation (SSOT established)
- âœ… Schema Export Enhancement specification (feature brief complete)
- âœ… Exit code escaping fixes (Python and TypeScript)
- âœ… Schema upgrades to JSON Schema 2020-12
- âœ… Code generation standard updated
- âœ… Sync configuration for app-identity assets
- âœ… CI validation for app-identity examples

**v0.2.5+ (Planned)**:

- ðŸ”œ Helper library implementations (gofulmen, pyfulmen, tsfulmen)
  - App Identity discovery functions
  - Schema export CLI commands
- ðŸ”œ Template integration (forge-workhorse-groningen, forge-workhorse-percheron)
  - CDRL workflow hooks for app identity
  - Schema export for validation and codegen

---

## Related

- [CHANGELOG](../CHANGELOG.md) - Full version history
- [App Identity Module Spec](../docs/standards/library/modules/app-identity.md)
- [Schema Export Feature Brief](../.plans/active/v0.2.4/schema-export-enhancement-feature-brief.md)
- [Code Generation Standard](../docs/standards/code-generation-template-standard.md)
- [Helper Library Standard](../docs/standards/library/fulmen-helper-library-standard.md)

---

## Credits

**Implementation**: Schema Cartographer (AI agent, supervised by @3leapsdave)
**Review**: @3leapsdave

---

For questions or issues, see the [CHANGELOG](../CHANGELOG.md) or open an issue on GitHub.
