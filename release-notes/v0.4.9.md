# v0.4.9 - JSON Schema Meta-Schema Expansion & Fulencode Contracts

Two major additions: complete offline JSON Schema validation coverage (Draft-04 through Draft-2020-12) and implementable contracts for the Fulencode encoding/normalization module.

## Highlights

- **Full JSON Schema Draft Coverage**: Offline validation from Draft-04 to Draft-2020-12
- **Fulencode Method Contracts**: 11 schemas defining encode/decode/detect/normalize operations
- **Cross-Language Parity Fixtures**: Test vectors for both meta-schema detection and encoding operations
- **text_safe Profile**: Security-focused normalization for log-safe and UI-safe text

## JSON Schema Meta-Schema Expansion

### Added Meta-Schemas

- **Draft-04**: `schemas/meta/draft-04/schema.json`
  - Single-file, self-contained meta-schema
  - Uses `id` instead of `$id` (pre-Draft-06 convention)
  - Common in SchemaStore and legacy tooling

- **Draft-06**: `schemas/meta/draft-06/schema.json`
  - Single-file, self-contained meta-schema
  - Introduced `$id`, `const`, `contains`, `propertyNames`
  - Boolean schemas allowed (`true`/`false` as schemas)

- **Draft 2019-09**: `schemas/meta/draft-2019-09/`
  - `schema.json` - Canonical with `$ref` to modular vocabularies
  - `offline.schema.json` - Subset for offline validation (no external refs)
  - `meta/` - Modular vocabularies (core, applicator, validation, meta-data, format, content)
  - Uses `$recursiveAnchor`/`$recursiveRef` (replaced by `$dynamicAnchor` in 2020-12)
  - Introduced `$vocabulary`, `$anchor`, `unevaluatedProperties`, `unevaluatedItems`

### Test Fixtures

- `schemas/meta/fixtures/` - Minimal sample schemas for each draft
  - `draft-04-sample.json`
  - `draft-06-sample.json`
  - `draft-07-sample.json`
  - `draft-2019-09-sample.json`
  - `draft-2020-12-sample.json`

### Documentation

- `schemas/meta/README.md` - Draft selection guidance table, refresh workflow, offline strategy

### Draft Coverage Matrix

| Draft         | `$schema` URI                                  | Offline Support        |
| ------------- | ---------------------------------------------- | ---------------------- |
| Draft-04      | `http://json-schema.org/draft-04/schema#`      | Inherent (single-file) |
| Draft-06      | `http://json-schema.org/draft-06/schema#`      | Inherent (single-file) |
| Draft-07      | `http://json-schema.org/draft-07/schema#`      | Inherent (single-file) |
| Draft 2019-09 | `https://json-schema.org/draft/2019-09/schema` | `offline.schema.json`  |
| Draft 2020-12 | `https://json-schema.org/draft/2020-12/schema` | `offline.schema.json`  |

## Fulencode Module Contracts

### Method Schemas

New schemas in `schemas/library/fulencode/v1.0.0/` defining cross-language API contracts:

**Option Schemas** (input validation):

- `encode-options.schema.json` - Encoding operation parameters
- `decode-options.schema.json` - Decoding operation parameters
- `detect-options.schema.json` - Detection operation parameters
- `normalize-options.schema.json` - Normalization operation parameters

**Result Schemas** (output validation):

- `encoding-result.schema.json` - Encode operation response
- `decoding-result.schema.json` - Decode operation response
- `detection-result.schema.json` - Detection operation response
- `normalization-result.schema.json` - Normalization operation response
- `bom-result.schema.json` - BOM detection/manipulation response

**Error Envelope**:

- `fulencode-error.schema.json` - Standard error structure with codes, messages, and details

### Parity Test Fixtures

New fixtures in `config/library/fulencode/fixtures/` for cross-language parity testing:

- `valid-encodings/base64.yaml` - Valid Base64 encoding test cases
- `invalid-encodings/base64.yaml` - Invalid Base64 rejection cases
- `bom/bom.yaml` - BOM detection and manipulation cases
- `detection/detection.yaml` - Encoding detection test vectors
- `normalization/text-safe.yaml` - text_safe profile test cases
- `telemetry/telemetry-test-cases.yaml` - Metrics emission verification

### text_safe Normalization Profile

New documentation: `docs/standards/library/modules/fulencode-text-safe.md`

A security-focused normalization profile for log-safe and UI-safe text:

- **Purpose**: Prevent bidi injection, zero-width hiding, control character attacks
- **Algorithm**: NFC normalize → reject disallowed characters → combining mark cap
- **Rejects**: C0/C1 controls, bidi override/isolate, zero-width characters, excessive combining marks
- **Error codes**: `ZERO_WIDTH_CHARACTER`, `BIDI_CONTROL_CHARACTER`, `EXCESSIVE_COMBINING_MARKS`

## Helper Library Implementation

### MetaSchemaRegistry API

Helper libraries can now implement consistent meta-schema discovery:

```go
// Go example
type MetaSchemaRegistry interface {
    ListDrafts() []string                          // ["draft-04", "draft-06", ...]
    GetMetaSchema(draft string) ([]byte, error)    // Load meta-schema content
    GetOfflineMetaSchema(draft string) ([]byte, error)
    DetectDraft(schema []byte) (string, error)     // Detect from $schema field
}
```

### Fulencode Facade

Helper libraries implementing Fulencode now have SSOT contracts for:

- Input validation (option schemas)
- Output structure (result schemas)
- Error envelope format
- Parity test fixtures

## Background

**Meta-schema expansion** aligns with goneat v0.5.2, which was driven by dogfooding on SchemaStore where many schemas still use Draft-04. With crucible as SSOT:

1. Helper libraries embed consistent meta-schema copies
2. goneat can eventually consume from crucible instead of internal assets
3. Applications have deterministic offline validation across languages

**Fulencode contracts** complete the spec work identified in the v0.4.9 launch brief, making the module implementable by helper library teams with consistent cross-language behavior.

## References

- Feature brief: `.plans/active/v0.4.9/001-jsonschema-meta-expansion-feature-brief.md`
- Launch brief: `.plans/active/v0.4.9/fulencode-launch.md`
- Fulencode standard: `docs/standards/library/modules/fulencode.md`
- text_safe profile: `docs/standards/library/modules/fulencode-text-safe.md`
